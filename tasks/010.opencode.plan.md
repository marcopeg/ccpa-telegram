# Development plan: Add OpenCode Engine (010)

This plan breaks down [tasks/010.opencode.md](./010.opencode.md) into phases and steps. The adapter exists as a stub; we complete it for correct CLI usage, session handling, and project isolation.

---

## Phase 1: OpenCode adapter — invocation and args

**Goal:** Use `opencode run` with correct flags and project CWD; keep session and model behavior consistent with the task spec.

### Step 1.1 — Switch to `run` subcommand and positional prompt

- In `src/engine/adapters/opencode.ts`, replace the current args construction.
- Build args as: start with `"run"`; do **not** use `-p` or `--prompt`.
- Append `fullPrompt` as the **last** positional argument (single string).
- Remove the line that sets `args: ["-p", fullPrompt]` and the TODO about CLI flags.

### Step 1.2 — Add model flag when model is set

- After `"run"`, push `"-m"` and `model` only when `model` is truthy (adapter is created with `config.engineModel` by the registry).
- Use the same pattern as Copilot: `if (model) { args.push("--model", model); }` (or `-m`, per OpenCode docs both work).

### Step 1.3 — Add session continue flag

- Destructure `continueSession` from `options` in `execute()` (with `config`, `logger`).
- Compute `continueSessionRequested = config.engineSession && continueSession !== false` (same as Codex/Copilot).
- When `continueSessionRequested`, push `"-c"` (or `"--continue"`) before the prompt positional.
- Ensure order: `run` → optional `-m model` → optional `-c` → `fullPrompt`.

### Step 1.4 — Ensure spawn uses project CWD (project isolation)

- Keep `const cwd = config.cwd` and pass it to `spawn(cmd, args, { cwd, ... })`.
- Add a short comment that `cwd` is required so OpenCode sessions and config are scoped per project (no cross-project reuse).

---

## Phase 2: OpenCode adapter — progress and cleanup

**Goal:** Match Copilot-style progress reporting and remove stub wording.

### Step 2.1 — Add progress callback on stdout

- Destructure `onProgress` from `options` in `execute()`.
- In the `proc.stdout.on("data", ...)` handler, after appending to `stdout`, call `onProgress?.("OpenCode is responding...")` when the chunk has content (e.g. `chunk.trim()`), to avoid spamming on empty chunks.

### Step 2.2 — Remove stub comments and log

- Remove the file-level comment "Stub adapter for OpenCode CLI" and the "TODO: Confirm exact CLI flags...".
- Remove the `logger.warn("OpenCode adapter is a stub — CLI flags may need adjustment")` call.
- Optionally add a one-line comment above the args construction documenting the OpenCode `run` usage (e.g. `opencode run [-m model] [-c] "<prompt>"`).

---

## Phase 3: Session reset for OpenCode

**Goal:** /clean and session renewal start a new OpenCode session by sending `sessionMsg` without `--continue`.

### Step 3.1 — Include opencode in active-reset engines

- In `src/bot/commands/session.ts`, in the condition that decides whether to perform active reset (send sessionMsg without continue), add `config.engine === "opencode"`.
- The condition should be: `config.engine === "copilot" || config.engine === "codex" || config.engine === "opencode" || config.engine === "cursor"`.
- Update the JSDoc above the function to mention opencode in the list of active-reset engines (e.g. "copilot, codex, opencode, cursor").

---

## Phase 4: Verification

**Goal:** Confirm build, lint, config, CLI, run/continue, /clean, and project isolation.

### Step 4.1 — Build and lint

- Run `pnpm run build`; fix any TypeScript errors.
- Run `pnpm run lint`; run `pnpm run lint:fix` if needed and fix any remaining issues.

### Step 4.2 — Config and CLI acceptance

- Confirm that a config with `"engine": { "name": "opencode" }` (and optional `model`, `session`, `sessionMsg`) passes Zod validation (e.g. via existing config load path or a quick test).
- Confirm that `--engine opencode` is accepted by the CLI (already wired; sanity-check help text).

### Step 4.3 — Runtime: single project

- With one project using `engine.name === "opencode"` and `engine.session === true`, send a message and assert a response.
- Send a follow-up message and assert the session is continued (e.g. model refers to prior context).
- Run `/clean` (or equivalent session reset) and assert a new session (e.g. send sessionMsg and then a new question; no prior context).

### Step 4.4 — Runtime: project isolation

- Use two different HAL projects (different `config.cwd`) both with `engine.name === "opencode"` and session enabled.
- In project A, send a message (e.g. "Remember the number 42").
- In project B, send a message with `--continue` semantics (next user message in same project); ensure project B does not see "42" or project A’s context.
- In project A again, send a follow-up; ensure project A still has its own session (e.g. can reference 42). This verifies sessions are keyed by CWD.

---

## Summary

| Phase | Description |
|-------|-------------|
| 1 | Adapter: `run` subcommand, positional prompt, `-m` when model set, `-c` when continue, spawn with `cwd: config.cwd` |
| 2 | Adapter: `onProgress` on stdout; remove stub comments and warn log |
| 3 | Session: add `opencode` to active-reset list in `session.ts` |
| 4 | Verification: build, lint, config/CLI, single-project run/continue/clean, two-project isolation |

No changes to `types.ts`, `registry.ts`, `config.ts`, or `cli.ts` — OpenCode is already registered and validated.
