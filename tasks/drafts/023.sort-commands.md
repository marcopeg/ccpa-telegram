# 023 — Sort commands in /help and Telegram UI

Status: draft

## Context
Commands should be grouped and ordered consistently in both the `/help` placeholder output and the Telegram command menu.

There are 5 command sources (defined as `CommandSource` in `src/bot/commands/loader.ts`):

| Source     | Origin                                | Current /help header  |
|------------|---------------------------------------|-----------------------|
| `project`  | `{projectCwd}/.hal/commands/*.mjs`    | *Project Commands*    |
| `skill`    | `.claude/skills/{name}/SKILL.md`      | *Project Skills*      |
| `system`   | `{configDir}/.hal/commands/*.mjs`     | *System Commands*     |
| `builtin`  | Hardcoded (start, help, reset, clean) | *Hal Commands*        |
| `git`      | Hardcoded (git_init, git_status, …)   | *Git Commands*        |

Required group order (top to bottom):
1. **Project Commands** — `source: "project"`
2. **Project Skills** — `source: "skill"` (only `public: true`)
3. **System Commands** — `source: "system"` (global `.hal/commands`, provided by HAL)
4. **Hal Commands** — `source: "builtin"` (start, help, reset, clean)
5. **Versioning** — `source: "git"` (git_init, git_status, git_commit, git_clean)

The git group section header must be renamed from "Git Commands" to "Versioning".

## Telegram API constraints

The Telegram Bot API `setMyCommands` accepts a flat array of `BotCommand` objects. There is **no native support for command grouping, sections, or visual separators** in the Telegram command menu. The only controllable aspect is the order of commands in the array, which Telegram preserves in the UI.

## Scope

### `/help` output (`buildHalCommands` in `src/bot/commands/message.ts`)
- Sections must appear in the required group order listed above.
- Rename the git section header from `*Git Commands:*` to `*Versioning:*`.

### Telegram command menu (`setMyCommands` in `src/bot.ts` and `src/bot/commands/watcher.ts`)
- The flat command list passed to `setMyCommands` must be sorted in the same group order: project → skills → system → builtin → git.
- Currently `loadCommands()` in `loader.ts` returns commands in map-insertion order (builtin → git → skills → system → project). This must be adjusted so the returned list follows the required order.

### Hot-reload of commands and skills (`src/bot/commands/watcher.ts`)
- Review and fix the command/skill hot-reload mechanism. Current observed behavior: adding a new command or skill while the bot is running does **not** push it to Telegram — a full process restart is required.
- Expected behavior: when a `.mjs` command file or `SKILL.md` is added, changed, or removed, the updated command list must be pushed to Telegram immediately (within the debounce window). The new command should appear the next time the user opens the Telegram command menu, without restarting the bot.
- Likely root cause to investigate: the watched directories (`.hal/commands/`, skills dir) may not exist at startup. Chokidar may fail to detect files added to directories that are created after the watcher starts. Verify chokidar's behavior with non-existent paths and fix accordingly (e.g. watch parent directories, create missing dirs at startup, or use chokidar's options for handling non-existent paths).
- Also verify that the watcher correctly handles: new files added, existing files modified, files removed.

### No changes to
- Command functionality or execution logic.
- Command precedence / override semantics (project overrides system overrides skills).

## Acceptance Criteria
- `/help` displays commands grouped and ordered: Project Commands, Project Skills, System Commands, Hal Commands, Versioning.
- The git section header in `/help` reads "Versioning", not "Git Commands".
- `setMyCommands` receives commands sorted in the same group order (project → skills → system → builtin → git).
- `loadCommands()` returns commands in the required order regardless of insertion-order side effects.
- Hot-reload works without process restart: adding/changing/removing a `.mjs` or `SKILL.md` file triggers re-registration with Telegram within the debounce window (~300ms).
- Hot-reload works even when the watched directories don't exist at startup and are created later.
- Existing command functionality and override precedence remain unchanged.
