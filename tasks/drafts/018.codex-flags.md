# 018 — Codex Engine Permission Flags

## Summary

Extend the engine configuration with Codex-specific permission flags to control sandbox and access levels per-project. Currently the Codex adapter hardcodes `--full-auto` (which maps to `--sandbox workspace-write --ask-for-approval on-request`), blocking network access and writes to protected paths (`.git`, `.codex`, `.agents`).

## Motivation

- Codex cannot fetch URLs or perform web requests (e.g., "fetch this repo's README") because `workspace-write` sandbox blocks outbound network by default.
- Codex cannot manage files under `.agents/skills/` or `.hal/commands/` because those are protected read-only paths in `workspace-write` mode.
- Operators need a way to grant elevated permissions per-project without editing adapter code.

## Configuration Schema

Add a `codex` object to the engine config in `hal.config.json`:

```json
{
  "engine": {
    "name": "codex",
    "codex": {
      "networkAccess": false,
      "fullDiskAccess": false,
      "dangerouslyEnableAllAccess": false
    }
  }
}
```

All three flags default to `false`.

### Flag Definitions

#### `networkAccess` (boolean, default: `false`)

Unlocks outbound network for Codex shell commands (HTTP requests, curl, fetch, etc.).

**Codex flag mapping:** adds `-c sandbox_workspace_write.network_access=true` while keeping the `workspace-write` sandbox intact.

**What changes:** shell commands spawned by Codex can make outbound connections. Filesystem restrictions remain the same as default (workspace-writable, protected paths read-only).

#### `fullDiskAccess` (boolean, default: `false`)

Grants unrestricted filesystem read/write access, including to protected paths (`.git`, `.codex`, `.agents`).

**Codex flag mapping:** replaces `--full-auto` with `--sandbox danger-full-access --ask-for-approval on-request`. The `danger-full-access` sandbox mode is the only way to unlock writes to protected directories like `.agents/skills/`.

**What changes:** Codex can create, modify, and delete any file in the workspace (including skills, commands, git config). Network is also unlocked as a side effect of `danger-full-access` — `networkAccess` becomes redundant when this flag is set. Codex still asks for approval on escalated operations.

#### `dangerouslyEnableAllAccess` (boolean, default: `false`)

Maximum permissive mode. Disables all sandboxing and all approval prompts.

**Codex flag mapping:** uses `--dangerously-bypass-approvals-and-sandbox` (alias: `--yolo`). No Landlock/Seatbelt sandbox, no approval prompts, commands run with full user-account permissions.

**What changes:** Codex operates with zero restrictions — equivalent to running commands directly in your terminal. **Only use in externally hardened environments (Docker, VMs).**

### Flag Precedence (escalating tiers)

These flags form escalating permission tiers. A higher tier supersedes lower ones:

1. **Default** — `--full-auto --skip-git-repo-check` (workspace-write, no network)
2. **`networkAccess`** — Default + network access
3. **`fullDiskAccess`** — Full filesystem + network (implies `networkAccess`)
4. **`dangerouslyEnableAllAccess`** — No sandbox, no approvals (implies everything)

The adapter should resolve from most permissive down. Conflicting combinations (e.g., `fullDiskAccess: true` + `networkAccess: false`) are resolved in favor of the higher tier.

## Implementation

### Config schema (`src/config.ts`)

Add a `CodexEngineConfigSchema` inside `EngineConfigSchema`:

```typescript
const CodexEngineConfigSchema = z.object({
  networkAccess: z.boolean().optional(),
  fullDiskAccess: z.boolean().optional(),
  dangerouslyEnableAllAccess: z.boolean().optional(),
}).optional();
```

Add `codex: CodexEngineConfigSchema` to the engine config object. Resolve the values in `resolveProjectConfig()` and expose them on `ResolvedProjectConfig`.

### Codex adapter (`src/engine/adapters/codex.ts`)

Pass the resolved codex flags to `createCodexAdapter()`. In the `execute()` method, compute CLI args based on the highest active tier:

```
if dangerouslyEnableAllAccess:
  replace --full-auto with --dangerously-bypass-approvals-and-sandbox
elif fullDiskAccess:
  replace --full-auto with --sandbox danger-full-access --ask-for-approval on-request
elif networkAccess:
  keep --full-auto, add -c sandbox_workspace_write.network_access=true
else:
  keep --full-auto (current behavior, no change)
```

Always append `--skip-git-repo-check`.

### Logging

Log the resolved permission tier at engine startup (info level) so operators can verify what's active. Log a warning when `dangerouslyEnableAllAccess` is set.

## Reference: Codex CLI Flags

From `codex --help` and Codex config documentation:

| Flag / Config | Purpose |
|---|---|
| `--sandbox read-only\|workspace-write\|danger-full-access` | Filesystem + network sandbox mode |
| `--ask-for-approval untrusted\|on-request\|never` | When to pause for human approval |
| `--full-auto` | Shorthand for `--sandbox workspace-write --ask-for-approval on-request` |
| `--dangerously-bypass-approvals-and-sandbox` / `--yolo` | No sandbox, no approvals |
| `--add-dir <DIR>` | Extra writable roots (workspace-write mode) |
| `-c key=value` | Runtime config override (e.g., `sandbox_workspace_write.network_access=true`) |
| `--skip-git-repo-check` | Bypass trusted-directory check |

Protected paths in `workspace-write` mode (always read-only): `.git`, `.codex`, `.agents`.
