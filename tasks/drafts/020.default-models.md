# Default models per engine (Option A)

## Goal

When `engine.model` is not set (neither in project nor in globals), behavior depends on the engine:

- **Engines with their own default:** Do not pass `--model` / `-m` so the CLI uses its built-in default (Codex, Copilot, Cursor).
- **Engines that need an explicit model:** Use a HAL-defined default from `src/default-models.ts` (Claude Code, OpenCode).

Behavior is implemented at **engine level**: the effective model is resolved once when creating the engine adapter. Adapters that receive `undefined` do not pass the model flag (except Cursor, which passes `--model auto` so the engine chooses).

Default model resolution applies to **both** call sites of `getEngine()` in `src/cli.ts`:

- **`runBotsForConfig`** — the main bot loop; resolves `config.engineModel ?? getDefaultEngineModel(config.engine)`.
- **`runInit`** — engine validation during init; also resolves the HAL default so the engine is tested with the same model that would be used at runtime. In the future, `runInit` will be expanded to ask the user for model preferences.

## Single source: `src/default-models.ts`

- **`DEFAULT_ENGINE_MODEL`** — `Partial<Record<EngineName, string>>` listing only engines that require an explicit default. Omitted engines mean "do not pass model; let the CLI choose."
- **`getDefaultEngineModel(engine)`** — returns the default model string or `undefined`. The caller uses `config.engineModel ?? getDefaultEngineModel(config.engine)` and passes the result to `getEngine()`; when it's `undefined`, adapters omit the model flag (Cursor uses `model || "auto"`).

## Which engines use which behavior

| Engine        | When `engine.model` omitted | Notes |
|---------------|-----------------------------|--------|
| **Claude Code** | HAL default: `default`      | Official alias for account-recommended model. Entry in `default-models.ts`. |
| **Codex**     | Engine default              | No entry; we don't pass `-m`. Codex CLI uses its recommended model (e.g. gpt-5.3-codex). |
| **Copilot**   | Engine default              | No entry; we don't pass `--model`. Copilot uses its own default. |
| **Cursor**    | Engine default              | No entry; adapter passes `--model auto` when model is undefined, so Cursor chooses. |
| **OpenCode**  | HAL default: `opencode/gpt-5-nano` | Permanently free Zen model (400k context). Alternative: `opencode/minimax-m2.5-free` (temporarily free, 205k ctx, data collected for training). Entry in `default-models.ts`. |
| **Antigravity** | TBD when engine is added   | Research CLI; add entry to `default-models.ts` if it has no "omit = default" behavior. Add placeholder comment in `default-models.ts` now. |

## Implementation plan

### 1. Add `src/default-models.ts`

- Import `EngineName` from `./engine/types.js`.
- Export **`DEFAULT_ENGINE_MODEL`**: `Partial<Record<EngineName, string>>` with:
  - `claude: "default"`
  - `opencode: "opencode/gpt-5-nano"`
- Export **`getDefaultEngineModel(engine: EngineName): string | undefined`** — return `DEFAULT_ENGINE_MODEL[engine]`. No entry for Codex, Copilot, Cursor (so they get `undefined`).
- Add a short JSDoc explaining that only engines that need an explicit model are in the map; others use engine default when model is omitted.
- Add a `// TODO: Antigravity — add entry here once the engine adapter is implemented.` placeholder comment.

### 2. Resolve effective model at both `getEngine()` call sites

In `src/cli.ts`, apply default model resolution at **both** places `getEngine()` is called:

- **`runBotsForConfig`** (main bot loop):
  - `effectiveModel = config.engineModel ?? getDefaultEngineModel(config.engine)`
  - Pass `effectiveModel` (which may be `undefined`) into `getEngine(config.engine, config.engineCommand, effectiveModel)`.
- **`runInit`** (engine validation during init):
  - `effectiveModel = getDefaultEngineModel(engineName)`
  - Pass `effectiveModel` into `getEngine(engineName, undefined, effectiveModel)` so the engine is tested with the same default model it would use at runtime.

No adapter changes required: adapters already only add `--model` / `-m` when `model` is truthy; Cursor already uses `model || "auto"`.

### 3. Document in README.md

- Under **Engine Configuration**, add a subsection **Model defaults** (after the engine table and before or after the per-engine subsections) that:
  - States that when `engine.model` is omitted, behavior depends on the engine.
  - Explains **engine default**: for Codex, Copilot, and Cursor, HAL does not pass a model flag so the CLI uses its own default (or Cursor's `auto`).
  - Explains **HAL default**: for Claude Code and OpenCode, HAL passes a default from `src/default-models.ts` (Claude: `default`, OpenCode: `opencode/gpt-5-nano`). Point readers to that file to see or change defaults.
- Update the `engine.model` row in the engine table so the Default column says something like: _(engine default or HAL default; see [Model defaults](#model-defaults))_.
- Ensure the globals table `globals.engine.model` and project table `engine.model` descriptions reference the same behavior (omit -> engine or HAL default per engine).

## Out of scope

- Changing how engines discover or list models (e.g. `/model` or task 021).
- Config schema changes: `engine.model` remains optional.

## Verification

- With no `engine.model` in config: Claude and OpenCode use HAL defaults from `default-models.ts`; Codex, Copilot, Cursor use engine default (no model flag, or Cursor's `auto`).
- With `engine.model` set (project or globals), that value is used for all engines.
- `runInit` resolves the HAL default so engine validation uses the same model as runtime.
- README clearly describes engine default vs HAL default and where to change HAL defaults.
- `pnpm run build` and `pnpm run lint` pass.
