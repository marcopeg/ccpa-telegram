# Add OpenCode Engine

Add support for the OpenCode CLI as an engine adapter. Scope: **opencode adapter only** — no docs changes, no other engine modifications. The adapter already exists as a stub; this task completes it to match Copilot/Codex session behavior and documented CLI usage.

## Config shape

Same as existing engines (aligned with task 006 and 011):

```json
"engine": {
    "name": "opencode",
    "model": "openai/gpt-4o",
    "session": true,
    "sessionMsg": "hi!"
}
```

- **name**: `"opencode"`
- **model**: Any model in `provider/model` form (e.g. `openai/gpt-4o`). Use `opencode models` or `opencode models [provider]` to list. No default in config — omit `--model` when not set (task 020 will define a hard-coded default per engine).
- **session** / **sessionMsg**: Same semantics as Copilot/Codex. `--continue` resumes last session; session renewal (e.g. /clean) sends `sessionMsg` without `--continue` to force a new engine session.

## Project isolation

Each project must be isolated: **the agent’s session must be tied to the project’s cwd**. No cross-project session reuse.

From [OpenCode config docs](https://opencode.ai/docs/config): *"When OpenCode starts up, it looks for a config file in the **current directory** or traverse up to the nearest Git directory."* Project config (`opencode.json`) and session storage are scoped by that directory. The `opencode run` command does **not** expose a `--cwd` or `--dir` flag for local (non-attach) runs; working directory is the process CWD.

**Therefore:** always spawn the OpenCode process with `cwd: config.cwd` (the project root). That ensures:
- OpenCode loads project config from that directory (or its Git root).
- Sessions created/continued are scoped to that project only.
- Two HAL projects with different `config.cwd` have independent OpenCode sessions (no cross-talk).

## OpenCode CLI reference

- **Docs**: [OpenCode CLI](https://opencode.ai/docs/cli), [run command](https://opencode.ai/docs/cli#run).
- **Non-interactive**: `opencode run [message..]` — run with a prompt and exit. No TUI.
- **Working directory**: No `--cwd`/`--dir` for local `opencode run`; process CWD defines project and session scope. **Always spawn with `cwd: config.cwd`** (see Project isolation above).

Key flags for `opencode run`:

| Flag | Purpose |
|------|--------|
| `-m, --model <provider/model>` | Model to use (e.g. `openai/gpt-4o`). Omit when no engine.model. |
| `-c, --continue` | Continue the last session in the current (CWD) project. |
| `-s, --session <id>` | Continue a specific session (HAL uses “last” only → `-c`). |
| `--agent` | Agent to use (optional; not used in v1). |

The prompt is the **positional argument** after `run` (e.g. `opencode run "user message"`).

**Version check**: `opencode --version` (global flag).

## Relations to other tasks

- **006 (multi-engine)**: Instruction file for opencode is `AGENTS.md`; skills dir remains `.claude/skills` (engine-portable). No change.
- **020 (default models)**: Default model for OpenCode will be set in 020; adapter must omit `--model` when config has no `engine.model`.
- **021 (switch model)**: `/model` will update project config; adapter only needs to respect `engine.model` and optional CLI override.
- **015 (config hot-reload)**: No direct impact on this task; config changes (e.g. model) will apply after reload.

## Implementation plan

### 1. Update `src/engine/adapters/opencode.ts`

Current file is a stub (wrong invocation and no session handling). Change to:

- **Invocation**: Use subcommand `run` and pass `fullPrompt` as the single positional argument. Do not use `-p`/`--prompt`; the docs use positionals for the message.
- **Args** (in order):
  - `run`
  - `-m`, `model` — only when `model` is set (from adapter or config)
  - `-c` — only when `config.engineSession && continueSession !== false`
  - `fullPrompt` as final positional
- **Process**: Spawn with **`cwd: config.cwd`** (required for project isolation — see above), `stdio: ["ignore", "pipe", "pipe"]`. Collect stdout/stderr; on close resolve `EngineResult` with `success: code === 0`.
- **Progress**: Call `onProgress("OpenCode is responding...")` when stdout chunks arrive (same pattern as Copilot).
- **check()**: Keep `opencode --version` via `execSync`.
- **parse()**: Return `result.output` on success, `result.error` on failure (same as Copilot/Codex).
- **skillsDir()**: Keep `join(projectCwd, ".claude", "skills")`.
- **instructionsFile()**: Keep `"AGENTS.md"`.

Remove stub/TODO comments once behavior is confirmed.

### 2. Modify `src/bot/commands/session.ts`

Add `"opencode"` to the active-reset engine check (same block as copilot, codex, cursor). Session renewal must send `sessionMsg` without `--continue` so the engine starts a new session:

```typescript
if (
  config.engine === "copilot" ||
  config.engine === "codex" ||
  config.engine === "opencode" ||
  config.engine === "cursor"
) {
```

### 3. No changes needed

- **types.ts**, **registry.ts**, **config.ts**, **cli.ts**: OpenCode is already in `EngineName`, `ENGINE_NAMES`, registry, Zod schema, and CLI `VALID_ENGINES` / help text.

## Verification

After implementation:

1. `pnpm run build` compiles without errors.
2. `pnpm run lint` passes (run `pnpm run lint:fix` if needed).
3. Config with `"engine": { "name": "opencode" }` (and optional `model`, `session`, `sessionMsg`) is accepted by Zod.
4. `--engine opencode` is accepted by the CLI.
5. With a project using `engine.name === "opencode"`, a message runs OpenCode and returns a response; with `engine.session === true`, a follow-up message continues the session (same project CWD).
6. `/clean` (or session reset) sends `sessionMsg` without `--continue` and starts a new OpenCode session.
7. **Project isolation**: Two different HAL projects (different `config.cwd`) using OpenCode have independent sessions — continuing in project A does not resume project B’s session, and vice versa.

## Research note (out of scope for this task)

The original task asked to find documentation for: (a) how to specify the model and common models for copilot, codex, cursor, claude code; (b) custom engines (e.g. OpenRouter, LM Studio). That is useful for task 020 (default models) and 021 (/model list). For this task, only OpenCode’s `-m provider/model` and `opencode models` matter; defaults and model discovery are left to 020/021.
