# Development plan: Add Google Antigravity Engine (026)

This plan breaks down [026.antigravity-engine.md](./026.antigravity-engine.md) into phases and steps. The integration uses **Gemini CLI** (`gemini` command) as the headless automation path, following the Claude adapter pattern (streaming JSON output, explicit session IDs).

---

## Phase 1: Registration wiring ✅

**Goal:** Make `"antigravity"` a valid engine name across types, config validation, and the adapter registry — without a functional adapter yet.

### Step 1.1 — Add to `EngineName` type and `ENGINE_NAMES` array

- In `src/engine/types.ts`, add `"antigravity"` to the `EngineName` union type.
- Add `"antigravity"` to the `ENGINE_NAMES` array.

### Step 1.2 — Add to config schema and resolved config

- In `src/config.ts`:
  - Add `"antigravity"` to the `EngineNameSchema` enum.
  - Create `AntigravityEngineConfigSchema` with:
    - `approvalMode`: `z.enum(["default", "auto_edit", "yolo"])` (optional)
    - `sandbox`: `z.boolean()` (optional)
  - Add `antigravity: AntigravityEngineConfigSchema` to `EngineConfigSchema`.
  - Add `antigravity` block to `ResolvedProjectConfig` interface:
    ```
    antigravity: {
      approvalMode: "default" | "auto_edit" | "yolo";
      sandbox: boolean;
    }
    ```
  - In `resolveProjectConfig()`, resolve `antigravity` fields with defaults:
    - `approvalMode`: project > globals > `"yolo"`
    - `sandbox`: project > globals > `false`

### Step 1.3 — Register adapter factory in registry

- In `src/engine/registry.ts`:
  - Import `createAntigravityAdapter` from `./adapters/antigravity.js`.
  - Add `antigravity: createAntigravityAdapter` to the `factories` record.

> At this point the adapter file doesn't exist yet, so the build will fail. This is resolved in Phase 2.

---

## Phase 2: Adapter implementation ✅

**Goal:** Implement the full Antigravity adapter with streaming JSON parsing, session management, and progress reporting.

### Step 2.1 — Create adapter skeleton

- Create `src/engine/adapters/antigravity.ts` with the `createAntigravityAdapter(command?, model?)` factory function.
- Set `DEFAULT_COMMAND = "gemini"`.
- Return an object implementing the `EngineAdapter` interface with stub methods.

### Step 2.2 — Implement `check()`

- Run `gemini --version` via `execSync` with `stdio: "pipe"`.
- On failure, throw an error with install guidance:
  `Gemini CLI command "<cmd>" not found or not executable. Please ensure Gemini CLI is installed and the command is in your PATH.`

### Step 2.3 — Implement `execute()` — args construction

- Destructure `sessionId`, `onProgress`, `continueSession` from options.
- Access `config.antigravity` for engine-specific flags.
- Build args array:
  1. `-p`, `fullPrompt`
  2. `--output-format`, `stream-json`
  3. `--approval-mode`, `config.antigravity.approvalMode`
  4. `--model`, `model` (only when model is set)
  5. `--resume`, `sessionId` (only when `sessionId` is truthy AND `config.engineSession` is true AND `continueSession !== false`)
  6. `--sandbox` (only when `config.antigravity.sandbox` is true)
- Set `cwd` to `config.cwd` for project isolation.

### Step 2.4 — Implement `execute()` — JSONL streaming and event parsing

- Spawn the subprocess with `stdio: ["ignore", "pipe", "pipe"]`.
- Parse stdout line-by-line as JSONL (same pattern as Claude adapter).
- Handle events:
  - **`init`**: Extract and store `sessionId` from event metadata.
  - **`tool_use`**: Build progress message from tool name/arguments; call `onProgress()`. Map Gemini tool names to descriptive messages (similar to Claude adapter's tool mapping).
  - **`thought`**: Log at debug level (do not send as progress).
  - **`message`**: Accumulate last assistant text as fallback output.
  - **`error`**: Log at warn level.
  - **`result`**: Capture final output, session ID, success/error status. Extract token stats from `stats.models` for `ParsedResponse`.
- On process `close`: resolve with `lastResult` if available, or build result from accumulated text and exit code.
- On process `error`: resolve with failure result.

> The exact field names in Gemini CLI's JSONL events may differ from Claude's. During implementation, run a test invocation (`gemini -p "hello" --output-format stream-json`) and inspect the actual output to map fields correctly. Add a comment in the adapter noting which fields were mapped and any assumptions.

### Step 2.5 — Implement `parse()`

- If `result.success` is false, return `{ text: result.error || "An unknown error occurred" }`.
- Attempt to parse `result.output` as JSON (Gemini's `result` event body).
  - Extract response text from `response` field (or equivalent).
  - Extract `sessionId` from event metadata.
  - Extract token counts from `stats.models.<model>.tokens` — map `prompt` → `inputTokens`, `candidates` → `outputTokens`.
  - Cost is not directly provided by Gemini CLI; omit `costUsd`.
- Fallback: return raw `result.output` as text.

### Step 2.6 — Implement `skillsDir()` and `instructionsFile()`

- `skillsDir(projectCwd)` → `join(projectCwd, ".agent", "skills")`
- `instructionsFile()` → `"GEMINI.md"`

---

## Phase 3: Example config ✅

**Goal:** Add Antigravity examples so operators can reference correct config shape.

### Step 3.1 — Add Antigravity project example to `examples/hal.config.json`

- Add a third project entry using `antigravity` engine:
  ```json
  {
    "name": "antigravity-project",
    "cwd": "./antigravity-project",
    "engine": {
      "name": "antigravity",
      "model": "gemini-2.5-pro",
      "session": true,
      "sessionMsg": "hi!",
      "antigravity": {
        "approvalMode": "yolo",
        "sandbox": false
      }
    },
    "telegram": {
      "botToken": "${ANTIGRAVITY_TELEGRAM_TOKEN}"
    }
  }
  ```

---

## Phase 4: Build and lint ✅

**Goal:** Confirm the implementation compiles and passes linting.

> **Execution note:** Build passed on first attempt. Lint found 2 unsafe optional chaining issues and 1 formatting issue in `antigravity.ts` — fixed via `lint:fix` and a manual edit to extract `runCmd` variable. All clean after fixes.

### Step 4.1 — Build

- Run `pnpm run build`; fix any TypeScript errors.

### Step 4.2 — Lint

- Run `pnpm run lint`; run `pnpm run lint:fix` if needed and fix remaining issues.

---

## Summary

| Phase | Description | Files |
|-------|-------------|-------|
| 1 | Registration: types, config schema + resolution, registry | `types.ts`, `config.ts`, `registry.ts` |
| 2 | Adapter: check, execute (args + JSONL parsing), parse, skillsDir, instructionsFile | `adapters/antigravity.ts` (new) |
| 3 | Example: Antigravity project in example config | `examples/hal.config.json` |
| 4 | Verification: build and lint pass | — |
