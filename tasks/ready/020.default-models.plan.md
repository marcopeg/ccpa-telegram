# Plan: Default models per engine

## Phase 1 — Create `src/default-models.ts`

### Step 1.1: Create the file

Create `src/default-models.ts` with:

```typescript
import type { EngineName } from "./engine/types.js";

/**
 * HAL-defined default models for engines that require an explicit model
 * when `engine.model` is omitted from config.
 *
 * Engines NOT listed here (Codex, Copilot, Cursor) use their own built-in
 * default when no model flag is passed.
 */
const DEFAULT_ENGINE_MODEL: Partial<Record<EngineName, string>> = {
  claude: "default",
  opencode: "opencode/gpt-5-nano",
  // TODO: Antigravity — add entry here once the engine adapter is implemented.
};

export function getDefaultEngineModel(
  engine: EngineName,
): string | undefined {
  return DEFAULT_ENGINE_MODEL[engine];
}
```

### Step 1.2: Re-export from engine barrel (if needed)

Check whether `src/default-models.ts` should be importable directly or re-exported. Since it's a top-level `src/` file (not under `engine/`), it will be imported directly as `./default-models.js` from `cli.ts`. No barrel changes needed.

---

## Phase 2 — Update `src/cli.ts` call sites

### Step 2.1: Add import

At the top of `src/cli.ts` (after line 17), add:

```typescript
import { getDefaultEngineModel } from "./default-models.js";
```

### Step 2.2: Update `runInit` (line 182)

In `runInit()`, replace:

```typescript
const engine = getEngine(engineName);
```

with:

```typescript
const effectiveModel = getDefaultEngineModel(engineName);
const engine = getEngine(engineName, undefined, effectiveModel);
```

This ensures the init-time engine check uses the same default model that would be used at runtime.

### Step 2.3: Update `runBotsForConfig` (lines 256–260)

In `runBotsForConfig()`, replace:

```typescript
const engine = getEngine(
  config.engine,
  config.engineCommand,
  config.engineModel,
);
```

with:

```typescript
const effectiveModel = config.engineModel ?? getDefaultEngineModel(config.engine);
const engine = getEngine(config.engine, config.engineCommand, effectiveModel);
```

---

## Phase 3 — Update README.md

### Step 3.1: Add "Model defaults" subsection (after line 505)

After the GitHub Copilot Models table and the sentence "If `engine.model` is omitted, the engine uses its own default model." (line 505), replace that line with a full **Model defaults** subsection:

```markdown
#### Model defaults

When `engine.model` is omitted (neither in globals nor project config), behavior depends on the engine:

- **Engine default** — Codex, Copilot, and Cursor: HAL does not pass a model flag, so the CLI picks its own default (Cursor passes `--model auto`).
- **HAL default** — Claude Code and OpenCode: HAL passes a built-in default so the engine always receives a model. Defaults are defined in `src/default-models.ts`:
  - Claude Code: `default` (account-recommended model)
  - OpenCode: `opencode/gpt-5-nano` (free Zen model)

To change HAL defaults, edit `src/default-models.ts`.
```

### Step 3.2: Update engine table `model` row (line 456)

Change:

```
| `model` | AI model override (omit to use the engine's default) | _(engine default)_ |
```

to:

```
| `model` | AI model override (omit for engine or HAL default; see [Model defaults](#model-defaults)) | _(per engine)_ |
```

### Step 3.3: Update globals table `globals.engine.model` row (line 270)

Change:

```
| `globals.engine.model` | Override the AI model | _(engine default)_ |
```

to:

```
| `globals.engine.model` | Override the AI model (see [Model defaults](#model-defaults)) | _(per engine)_ |
```

### Step 3.4: Update project table `engine.model` row (line 297)

Change:

```
| `engine.model` | No | Override the AI model |
```

to:

```
| `engine.model` | No | Override the AI model (see [Model defaults](#model-defaults)) |
```

---

## Phase 4 — Verify

### Step 4.1: Build and lint

```bash
pnpm run build
pnpm run lint
```

Both must pass cleanly.

### Step 4.2: Manual verification checklist

- [ ] `src/default-models.ts` exports `getDefaultEngineModel()` returning `"default"` for claude, `"opencode/gpt-5-nano"` for opencode, and `undefined` for codex/copilot/cursor.
- [ ] `runInit` in `cli.ts` calls `getEngine(engineName, undefined, effectiveModel)` with the resolved default.
- [ ] `runBotsForConfig` in `cli.ts` uses `config.engineModel ?? getDefaultEngineModel(config.engine)`.
- [ ] No adapter files were changed (adapters already handle truthy/undefined model correctly).
- [ ] README "Model defaults" subsection is present under Engine Configuration.
- [ ] README engine table, globals table, and project table all reference "Model defaults".
- [ ] Antigravity TODO placeholder exists in `default-models.ts`.
