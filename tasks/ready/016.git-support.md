# Git support (global commands)

Add a set of git-related Telegram commands (`/git_init`, `/git_status`, `/git_commit`, `/git_clean`) for managing git inside a project. All commands run in the project directory (`config.cwd`). Implementation lives in the codebase and is shipped with the package; commands are registered with Telegram via `setMyCommands` only when git is enabled for that bot.

## Config

### `commands.enabled` flag (all commands)

Extend the existing `commands` config block so that every command entry supports an `enabled` boolean. This applies to all built-in commands, not just git. The flag can live in **globals** and/or **per-project** (project overrides globals, same pattern as other optional features).

Defaults:
- `start`: **enabled** by default (can be disabled)
- `help`: **enabled** by default (can be disabled)
- `reset`: **enabled** by default (can be disabled)
- `clean`: **enabled** by default (can be disabled)
- `git`: **disabled** by default (must be explicitly enabled)

When a command is disabled, it must not be registered with Telegram (`setMyCommands`) and must not appear in the `/help` output.

### Schema

```json
{
  "commands": {
    "start": {
      "enabled": true,
      "session": { "reset": true },
      "message": { "from": ".hal/WELCOME.md" }
    },
    "help": {
      "enabled": true,
      "message": { "text": "Custom help" }
    },
    "reset": { "enabled": true },
    "clean": { "enabled": true },
    "git": { "enabled": true }
  }
}
```

- Add `enabled?: boolean` to each command entry in `CommandsConfigSchema`.
- Add `git?: { enabled?: boolean }` to `CommandsConfigSchema`. In the future `git` may grow additional sub-flags (e.g. per-command toggles for `git_init`, `git_status`, etc.), so treat it as a group config rather than a flat boolean.
- Resolve each command's enabled state in `ResolvedProjectConfig` (apply defaults, merge globals → project).
- When `commands.git.enabled` is true: wire git command handlers in `bot.ts`, include git commands in the merged list passed to `loadCommands` / `setMyCommands`.
- When any built-in command is disabled: skip its handler registration and exclude it from `setMyCommands`.

## Commands

### `/git_init`

- If the project directory is already a git repo, do nothing (or report "already a repo").
- If not, run `git init` and perform an initial commit (e.g. "Initial commit" or configurable message).

### `/git_status`

- Run `git status` in the project directory and send the output to the user (e.g. as a message or formatted reply).

### `/git_commit [message]`

- Run `git add` (stage all changes) then `git commit`.
- **If the user provides a message** (e.g. `/git_commit fix bug`): use that as the commit message.
- **If no message is passed**: use the AI engine (same as for chat) to generate a commit message from the current changes (e.g. run `git diff` / `git status`, send that to the engine with a prompt like "Generate a short commit message for these changes"), then commit with the generated message.

### `/git_clean [file_name]`

- Revert **uncommitted** changes only (working tree; e.g. `git restore <file>`). Do not undo commits.
- **When a single file is passed and can be parsed**: revert that file and confirm to the user (no extra UI flow required, unless you want a simple confirm for consistency).
- **When no file is passed or the argument cannot be easily parsed**: use Telegram UI to let the user choose what to revert:
  1. **File list**: Send a message listing **files with uncommitted changes** (e.g. from `git status --short` or equivalent). Present them so the user can select which file(s) to revert. Include an option **"Reset all"** (revert all such files).
  2. **Selection**: User selects one or more files (or "Reset all") via Telegram UI (e.g. inline keyboard with callback buttons).
  3. **Confirm step**: After selection, send a second message that:
     - Lists the file(s) that will be reset.
     - Asks: "Confirm reset these files and lose the changes?"
     - Provides **Confirm** and **Cancel** buttons in the Telegram UI (inline keyboard). On Confirm, run `git restore` for the chosen file(s). On Cancel, abort and optionally notify the user.

Implementation note: use Telegram **inline keyboards** (`InlineKeyboardButton` with `callback_data`) and a **callback_query** handler to process the user's choices and the final confirm/cancel. This is the standard pattern for confirm flows in the Bot API.

## Help integration

When `git.enabled` is true, the git commands must appear in the `/help` output under a dedicated **"Git Commands"** group.

### Help section order

Reorder the sections produced by `buildHalCommands()` to:

1. **Project Commands** — programmatic `.mjs` commands from the project's `.hal/commands` directory (if any)
2. **Project Skills** — public skill commands (if any)
3. **System Commands** — programmatic `.mjs` commands from the root config dir's `.hal/commands` (if any)
4. **Hal Commands** — built-in commands (`start`, `help`, `reset`, `clean`)
5. **Git Commands** — git commands (`git_init`, `git_status`, `git_commit`, `git_clean`), only when enabled

Each section is only shown if it has at least one command. Only enabled commands appear.

### Command source tracking

Currently `buildHalCommands()` groups all `.mjs` commands into a single "Custom Commands" section without distinguishing their origin. To support the split into "Project Commands" vs "System Commands", the command loader must track the **source** of each `.mjs` command (project-level vs config-dir-level) so `buildHalCommands()` can place them in the correct section.

## Summary

- **Built-in style**: Git commands are implemented as handlers in `src/bot/commands/` (like start, help, reset, clean), not as `.mjs` or skills.
- **Enabled flag**: All built-in commands gain an `enabled` boolean in the `commands` config. Git defaults to disabled; all others default to enabled.
- **Registration**: Only enabled commands are registered with the bot and included in `setMyCommands`.
- **Help**: Git commands appear in a dedicated "Git Commands" section at the end of the help output. Help sections are reordered to prioritize project-specific commands over system/built-in ones.
- **Scope**: All git operations run in `config.cwd`. No project-specific overrides beyond the config flags.
