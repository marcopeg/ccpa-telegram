# 023 — Sort commands in /help and Telegram UI — Plan

## Phase 1: Define canonical source ordering (`src/bot/commands/loader.ts`)

### Step 1.1 — Add `SOURCE_ORDER` constant
Add a `SOURCE_ORDER` record that maps each `CommandSource` to a numeric priority:

```typescript
const SOURCE_ORDER: Record<CommandSource, number> = {
  project: 0,
  skill: 1,
  system: 2,
  builtin: 3,
  git: 4,
};
```

### Step 1.2 — Add `sortBySource` utility
Add a comparator function that sorts a `CommandEntry[]` by `SOURCE_ORDER`:

```typescript
function sortBySource(a: CommandEntry, b: CommandEntry): number {
  return SOURCE_ORDER[a.source] - SOURCE_ORDER[b.source];
}
```

### Step 1.3 — Sort `loadCommands()` output
Before returning from `loadCommands()`, sort the array:

```typescript
return Array.from(map.values()).sort(sortBySource);
```

This ensures every consumer (`setMyCommands` at startup, the watcher republish, `buildHalCommands`) receives commands in the correct group order.

---

## Phase 2: Rename git section header (`src/bot/commands/message.ts`)

### Step 2.1 — Rename `*Git Commands:*` to `*Versioning:*`
In `buildHalCommands()`, change line 81:

```typescript
// before
sections.push(`*Git Commands:*\n${formatCommandList(gitCommands)}`);
// after
sections.push(`*Versioning:*\n${formatCommandList(gitCommands)}`);
```

### Step 2.2 — Update JSDoc comment
Update the function's doc comment to reflect the new section name (replace "Git Commands" with "Versioning").

---

## Phase 3: Fix hot-reload watcher (`src/bot/commands/watcher.ts`)

### Step 3.1 — Ensure watched directories exist before starting chokidar
Chokidar v5 silently swallows `ENOENT` for non-existent paths but never starts monitoring them when they are created later. This is the confirmed root cause.

Before calling `chokidar.watch(watchPaths, ...)`, ensure each directory exists:

```typescript
import { mkdirSync } from "node:fs";

for (const dir of watchPaths) {
  mkdirSync(dir, { recursive: true });
}
```

This is safe because:
- `.hal/commands/` and the skills dir are well-known project structure directories.
- Creating them empty has no side effects — `scanCommandDir` / `scanSkillsDir` return `[]` for empty dirs.
- It guarantees chokidar establishes a real fs watch from the start.

### Step 3.2 — Verify add/change/unlink handling
After the fix, verify the three event paths work:
- **add**: drop a new `.mjs` file into `.hal/commands/` → appears in Telegram menu.
- **change**: edit an existing `.mjs` description → updated in Telegram menu.
- **unlink**: remove a `.mjs` file → disappears from Telegram menu.

Same for `SKILL.md` files in the skills directory.

---

## Phase 4: Verify end-to-end

### Step 4.1 — Build and lint
Run `pnpm run build` and `pnpm run lint` to confirm no regressions.

### Step 4.2 — Manual verification checklist
- Start the bot with no project commands/skills dirs existing → dirs are created, watcher starts cleanly.
- `/help` shows sections in order: Project Commands, Project Skills, System Commands, Hal Commands, Versioning.
- Git section header reads "Versioning", not "Git Commands".
- Telegram command menu shows commands in the correct group order.
- Add a `.mjs` command file while the bot runs → appears in Telegram menu without restart.
- Remove it → disappears from Telegram menu without restart.

---

## Files changed

| File | Change |
|------|--------|
| `src/bot/commands/loader.ts` | Add `SOURCE_ORDER`, `sortBySource`, sort in `loadCommands()` |
| `src/bot/commands/message.ts` | Rename git section header to "Versioning", update JSDoc |
| `src/bot/commands/watcher.ts` | `mkdirSync` for watched dirs before starting chokidar |
