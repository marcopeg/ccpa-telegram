# 024 — Expose skills across engines — Plan

## Phase 1: Interface change

Update the `EngineAdapter` interface to return multiple skill directories.

### Step 1.1 — Change `skillsDir` to `skillsDirs` on `EngineAdapter`

**File:** `src/engine/types.ts`

- Rename `skillsDir(projectCwd: string): string` to `skillsDirs(projectCwd: string): string[]`
- Update the JSDoc to reflect the new semantics: returns an ordered list of skill directories (highest priority first)

## Phase 2: Engine adapters

Update each adapter to return the correct ordered list per the research mapping.

### Step 2.1 — Claude adapter

**File:** `src/engine/adapters/claude.ts`

- Rename `skillsDir` to `skillsDirs`
- Return `[join(projectCwd, ".claude", "skills")]`
- (Single entry — Claude does not support `.agents/skills`)

### Step 2.2 — Codex adapter

**File:** `src/engine/adapters/codex.ts`

- Rename `skillsDir` to `skillsDirs`
- Return `[join(projectCwd, ".agents", "skills")]`
- Remove the legacy comment about sharing `.claude/skills`

### Step 2.3 — Copilot adapter

**File:** `src/engine/adapters/copilot.ts`

- Rename `skillsDir` to `skillsDirs`
- Return `[join(projectCwd, ".agents", "skills"), join(projectCwd, ".github", "skills"), join(projectCwd, ".claude", "skills")]`

### Step 2.4 — OpenCode adapter

**File:** `src/engine/adapters/opencode.ts`

- Rename `skillsDir` to `skillsDirs`
- Return `[join(projectCwd, ".agents", "skills"), join(projectCwd, ".opencode", "skills"), join(projectCwd, ".claude", "skills")]`

### Step 2.5 — Cursor adapter

**File:** `src/engine/adapters/cursor.ts`

- Rename `skillsDir` to `skillsDirs`
- Return `[join(projectCwd, ".agents", "skills"), join(projectCwd, ".cursor", "skills")]`

## Phase 3: Skill loader

Update the loader to scan multiple directories and deduplicate.

### Step 3.1 — Update `loadCommands` signature

**File:** `src/bot/commands/loader.ts`

- Change parameter `skillsDir?: string` to `skillsDirs?: string[]`
- Scan each directory in order using the existing `scanSkillsDir` function
- Deduplicate by skill name: iterate directories in priority order, skip any skill whose `command` name is already in the map (first-found wins)

Implementation sketch:
```typescript
const skillEntries: CommandEntry[] = [];
const seenSkills = new Set<string>();
if (skillsDirs) {
  for (const dir of skillsDirs) {
    const dirSkills = await scanSkillsDir(dir, logger);
    for (const skill of dirSkills) {
      if (!seenSkills.has(skill.command)) {
        seenSkills.add(skill.command);
        skillEntries.push(skill);
      }
    }
  }
}
```

### Step 3.2 — Update `resolveSkillEntry` signature

**File:** `src/bot/commands/loader.ts`

- Change parameter `skillsDir: string` to `skillsDirs: string[]`
- Iterate directories in order, return the first match found

Implementation sketch:
```typescript
for (const dir of skillsDirs) {
  const skillMdPath = join(dir, commandName, "SKILL.md");
  if (existsSync(skillMdPath)) {
    const parsed = await parseSkillMd(skillMdPath, logger);
    if (parsed) {
      // ... return entry
    }
  }
}
return null;
```

## Phase 4: Helper function

### Step 4.1 — Update `getSkillsDir` to `getSkillsDirs`

**File:** `src/agent/index.ts`

- Rename to `getSkillsDirs`, return `string[]`
- Delegate to `ctx.engine.skillsDirs(projectCwd)` when engine is available
- Fallback: return `[join(projectCwd, ".claude", "skills")]`

## Phase 5: Call sites

Update every consumer of the old single-path API.

### Step 5.1 — `src/bot.ts`

- Change `const skillsDir = engine.skillsDir(config.cwd)` to `const skillsDirs = engine.skillsDirs(config.cwd)`
- Pass `skillsDirs` (array) to `loadCommands` and `startCommandWatcher`

### Step 5.2 — `src/bot/commands/watcher.ts`

- Change parameter `skillsDir?: string` to `skillsDirs?: string[]`
- Change `if (skillsDir) watchPaths.push(skillsDir)` to `if (skillsDirs) watchPaths.push(...skillsDirs)`
- Pass `skillsDirs` to `loadCommands` in the `republish` function
- Update debug log to reflect the array

### Step 5.3 — `src/bot/commands/message.ts`

- Change `engine.skillsDir(config.cwd)` to `engine.skillsDirs(config.cwd)` in `buildHalCommands`
- Pass the array to `loadCommands`

### Step 5.4 — `src/bot/handlers/text.ts`

- Change `getSkillsDir` import to `getSkillsDirs`
- Pass the array to `resolveSkillEntry`

## Phase 6: Documentation

### Step 6.1 — Update `README.md`

Add a section documenting the engine-to-skill-sources mapping:

| Engine    | Skill directories (priority order)                     |
|-----------|--------------------------------------------------------|
| Claude    | `.claude/skills`                                       |
| Codex     | `.agents/skills`                                       |
| Copilot   | `.agents/skills`, `.github/skills`, `.claude/skills`   |
| OpenCode  | `.agents/skills`, `.opencode/skills`, `.claude/skills` |
| Cursor    | `.agents/skills`, `.cursor/skills`                     |

Include a note on conflict resolution: when the same skill name exists in multiple directories, the highest-priority directory wins.

## Phase 7: Verify

### Step 7.1 — Lint and build

- Run `pnpm run lint:fix` to fix any formatting issues
- Run `pnpm run build` to verify TypeScript compilation
- Manually verify no remaining references to the old `skillsDir` (singular) exist
