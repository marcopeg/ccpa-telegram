# 022 — Interactive Engine Auto-Detection at Boot

## Context

When `hal.config.json` does not specify an `engine.name` (neither at project nor globals level), the bot currently falls back silently to `"claude"`. Instead, it should run an interactive CLI flow at boot time that helps the user detect, choose, and optionally persist an engine.

This happens **before** hot-reload is enabled for the config, so writing to `hal.config.json` at this stage will not trigger a process restart.

## Detection Priority Order (cosmetic)

When listing detected engines, present them in this order:

1. opencode
2. claude
3. copilot
4. cursor
5. codex

Only available engines are shown. The order is cosmetic — no pre-selection or default.

## Interactive CLI Flow

### Step 1 — Missing engine prompt

If no engine is configured, show:

> No engine config found, do you want me to check your system and figure this out?

Interactive **y/n** prompt (accept `y`/`n` keypress or arrow-key selection + Enter).

- **No** → print:
  > Ok then, please fix your "hal.config.json" and set the "globals.engine.name" — then ping me again!
  
  Then exit the process.

### Step 2 — Auto-detection with progress

Test each engine in priority order. For each engine:

1. Run the adapter's `check()` to verify CLI binary exists.
2. If `check()` passes, run a simple prompt (`"hi"`) through the adapter to verify it can produce a response.
3. Show progress as a **single line that replaces itself** (overwrite the current line, not a growing log list), e.g.:
   - `Checking opencode... ✓ available`
   - then replaced by: `Checking claude... ✗ not found`
   - then replaced by: `Checking copilot... ✓ available`
   - etc.
4. After all engines are tested, clear the progress line.

Log every attempt and result via the logger (debug level) for troubleshooting — but **do not** print the log to the terminal as visible output.

### Step 3a — Engines found → choose

If at least one engine is available, show:

> I found the following available engines, which one do you want to use?

Present an **interactive list** with:
- Arrow keys (up/down) to navigate
- Number keys to jump to a choice
- Enter to confirm

Only show engines that passed detection, in priority order.

### Step 3b — No engines found → install guidance

If zero engines pass detection, show:

> Sorry, I couldn't find any working engine on your system. Pick one to install:

Present the **full list of supported engines** (all five, in priority order) as an interactive list (same UX as Step 3a).

When the user picks one, open their default browser to the engine's install page:

| Engine   | Install URL |
|----------|-------------|
| opencode | https://opencode.ai (verify current URL at implementation time) |
| claude   | https://docs.anthropic.com/en/docs/claude-code/overview |
| copilot  | https://docs.github.com/en/copilot/github-copilot-in-the-cli |
| cursor   | https://docs.cursor.com/agent |
| codex    | https://github.com/openai/codex |

Then exit the process with a message:

> Once installed, boot me again and I'll detect it!

### Step 4 — Persist to config

After engine selection, confirm:

> Great, you want to use "xxx", do you want me to add this to your configuration file? (recommended)

Interactive **y/n** prompt (accept `y`/`n` keypress or arrow-key selection + Enter).

- **Yes** → write `engine.name` into `globals.engine` in `hal.config.json`, preserving the rest of the file. Then continue boot normally.
- **No** → store the engine choice in memory (so the current process can use it), print:
  > Dude, I will do what you ask. But keep in mind that you are forcing me to re-run this task again next time you boot me up! Please consider storing this in your configuration file.
  
  Then continue boot normally.

## Acceptance Criteria

- [ ] Boot detects missing `engine.name` (not set at project or globals level) and triggers the interactive flow.
- [ ] The y/n prompts accept both keypress (`y`/`n`) and arrow-key selection + Enter.
- [ ] The engine selection list supports arrow-key navigation, number-key jump, and Enter to confirm.
- [ ] Detection progress displays as a single self-replacing line (not a growing list).
- [ ] All detection attempts (check + prompt) are logged at debug level.
- [ ] When no engines are found, browser opens to the install page of the selected engine.
- [ ] "Yes" to persist writes `globals.engine.name` into `hal.config.json` without corrupting the file.
- [ ] "No" to persist stores the choice in memory and the bot functions normally for that session.
- [ ] The interactive prompts work correctly in a standard terminal (stdin/stdout is a TTY).

## Technical Notes

- The interactive CLI should use a library like `@inquirer/prompts` or `prompts` — pick whichever integrates best with the existing stack (check `package.json` at implementation time).
- Use `\r` / ANSI escape codes or the chosen library's spinner/overwrite capabilities for the self-replacing progress line.
- The detection flow runs in `src/cli.ts` at boot time, after config is loaded but before bots are started and before hot-reload is set up.
- The resolved engine must be injected into `ResolvedProjectConfig` so the rest of the system uses it seamlessly.
- For the "open browser" action, use Node's `child_process` with `open` (macOS) / `xdg-open` (Linux) / `start` (Windows), or a cross-platform package like `open`.
