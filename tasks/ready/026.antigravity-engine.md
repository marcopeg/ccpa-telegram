# 026 — Add Google Antigravity Engine

Status: draft

## Context

HAL engine integrations (Codex, OpenCode, Cursor) are implemented as subprocess-based adapters with a stable command-line interface and non-interactive execution.

The goal is to add support for Google Antigravity using the same architecture and UX expectations.

## Research Summary

**Product overview:** Google Antigravity is an agent-first IDE (VS Code fork) released Nov 2025, in public preview as of early 2026. It provides Editor + Agent Manager surfaces for spawning and orchestrating autonomous agents.

**CLI automation path:** Antigravity itself is a GUI IDE and does not expose its own headless CLI binary. However, the official terminal counterpart is **Gemini CLI** (`gemini` command) — Google's open-source terminal AI agent that shares the same skills/rules ecosystem. Gemini CLI provides a fully documented, stable headless mode.

Sources reviewed:
- https://antigravity.google/ (product page)
- https://google-gemini.github.io/gemini-cli/docs/cli/headless.html (headless mode docs)
- https://geminicli.com/docs/cli/cli-reference/ (CLI cheatsheet)
- https://geminicli.com/docs/cli/session-management/ (session management)
- https://geminicli.com/docs/cli/skills/ (agent skills)
- https://antigravity.google/docs/rules-workflows (rules & workflows)
- https://google-gemini.github.io/gemini-cli/docs/cli/sandbox.html (sandboxing)

## Discovery Gate: PASSED

**Integration path: Gemini CLI headless mode** — stable, documented, non-interactive execution via subprocess.

### Gemini CLI capabilities (confirmed)

| Capability | Detail |
|---|---|
| Command | `gemini` |
| Headless mode | `gemini -p "prompt"` or `gemini "prompt"` (positional arg) |
| Output formats | `text` (default), `json` (structured), `stream-json` (JSONL streaming) |
| Model selection | `--model` / `-m` (default: `auto`; aliases: `pro`, `flash`, `flash-lite`) |
| Session resume | `--resume <uuid>` / `--resume "latest"` / `--resume <index>` |
| Sandbox | `--sandbox` / `-s` |
| Approval mode | `--approval-mode` (`default`, `auto_edit`, `yolo`) |
| Version check | `gemini --version` |
| Exit codes | `0` success, `1` error, `42` input error, `53` turn limit |

### Streaming JSON event types (`--output-format stream-json`)

JSONL events emitted line-by-line:
- `init` — session metadata (session ID, model)
- `message` — user and assistant message chunks
- `tool_use` — tool call requests with arguments
- `tool_result` — output from executed tools
- `thought` — model reasoning traces
- `error` — non-fatal warnings/system errors
- `result` — final outcome with aggregated statistics (token counts, tool stats)

### JSON output schema (`--output-format json`)

```json
{
  "response": "string",
  "stats": {
    "models": { "<model-name>": { "api": { ... }, "tokens": { "prompt": N, "candidates": N, "total": N, "cached": N } } },
    "tools": { "totalCalls": N, "totalSuccess": N, "totalFail": N, "byName": { ... } },
    "files": { "totalLinesAdded": N, "totalLinesRemoved": N }
  },
  "error": { "type": "string", "message": "string", "code": N }
}
```

## Implementation Approach

### Closest existing adapter: Claude

Gemini CLI's headless interface is architecturally closest to the Claude adapter:

| Feature | Claude adapter | Gemini CLI (proposed) |
|---|---|---|
| Stream output | `--output-format stream-json` | `--output-format stream-json` |
| Session model | Explicit `--resume <sessionId>` | Explicit `--resume <uuid>` |
| Session ID source | `init` event `session_id` | `init` event session metadata |
| Progress events | Tool use events from JSONL | Tool use events from JSONL |
| Token/cost stats | From `result` event | From `result` event `stats.models` |
| Model flag | `--model <m>` | `--model <m>` |
| Version check | `--version` | `--version` |

Key differences from Claude:
- Gemini requires `--approval-mode yolo` for non-interactive tool execution (Claude has no equivalent flag).
- Gemini has `--sandbox` mode for containerized/seatbelt execution.
- Gemini's JSONL event schema uses different field names (to be mapped during implementation).
- Gemini supports `--resume "latest"` — HAL should prefer explicit UUID for determinism.

### Session model: explicit `sessionId` (passive reset)

Like Claude, Gemini CLI uses explicit session IDs via `--resume <uuid>`. This means:
- HAL stores `sessionId` from the `init` event in `session.json`.
- Subsequent calls pass `--resume <uuid>` when `config.engineSession` is true.
- `/clean` clears `session.json` — the next call omits `--resume` and starts a fresh session.
- Antigravity is a **passive** engine for `/clean` (same as Claude): no active-reset engine call needed.
- The session reset condition in `src/bot/commands/session.ts` does NOT need to include `antigravity`.

### Skills and rules directories

| Path | Purpose |
|---|---|
| `.agent/skills/` | Workspace-level agent skills (directory-based, each with `SKILL.md`) |
| `.agent/rules/` | Workspace-level rules (markdown files, glob/manual/always-on activation) |
| `GEMINI.md` | Workspace root instructions file (entry point, references `AGENTS.md` and rules) |
| `~/.gemini/GEMINI.md` | Global rules (user-level) |

Adapter methods:
- `skillsDir(projectCwd)` → `join(projectCwd, ".agent", "skills")`
- `instructionsFile()` → `"GEMINI.md"`

## Scope

### Registration wiring (3 files)

1. `src/engine/types.ts` — add `"antigravity"` to `EngineName` union and `ENGINE_NAMES` array.
2. `src/config.ts` — add `"antigravity"` to `EngineNameSchema` enum. Add optional `antigravity` config block to schema.
3. `src/engine/registry.ts` — import `createAntigravityAdapter` and register in `factories`.

### Adapter implementation

New file: `src/engine/adapters/antigravity.ts`

CLI invocation pattern:
```
gemini -p <prompt> --output-format stream-json --approval-mode <mode> [--model <m>] [--resume <sessionId>] [--sandbox]
```

Adapter contract:
- `check()` — `gemini --version` via `execSync`.
- `execute()` — spawn subprocess, parse JSONL events line-by-line (same pattern as Claude adapter), extract session ID from `init`, progress from `tool_use`, final output from `result`.
- `parse()` — normalize `result` event into `ParsedResponse` with `text`, `sessionId`, token stats.
- `skillsDir()` → `.agent/skills/`
- `instructionsFile()` → `GEMINI.md`

### Engine-specific config

```json
"antigravity": {
  "approvalMode": "yolo",
  "sandbox": false
}
```

| Field | Type | Default | Maps to |
|---|---|---|---|
| `approvalMode` | `"default" \| "auto_edit" \| "yolo"` | `"yolo"` | `--approval-mode <value>` |
| `sandbox` | `boolean` | `false` | `--sandbox` (when true) |

Rationale:
- `approvalMode` defaults to `yolo` because HAL runs non-interactively — `default` and `auto_edit` would cause hangs or policy denials in headless mode.
- `sandbox` exposed as opt-in for operators who want containerized execution.

### Config example

```json
{
  "engine": {
    "name": "antigravity",
    "model": "gemini-2.5-pro",
    "session": true,
    "sessionMsg": "hi!"
  },
  "antigravity": {
    "approvalMode": "yolo",
    "sandbox": false
  }
}
```

## Acceptance Criteria

- `antigravity` can be selected in `hal.config.json` as `engine.name`.
- `gemini --version` is validated on startup via `check()`.
- Prompts execute via `gemini -p <prompt> --output-format stream-json --approval-mode <mode>`.
- Session ID is extracted from `init` event and persisted in `session.json`; subsequent calls pass `--resume <uuid>`.
- `/clean` clears `session.json` (passive reset, no active-reset engine call).
- `--model` is passed when configured; default model is `auto` (engine default).
- `--sandbox` is included when `antigravity.sandbox` is true.
- `--approval-mode` is set from `antigravity.approvalMode` (default `yolo`).
- Progress callbacks fire on `tool_use` events.
- `parse()` extracts response text and token statistics from `result` event.
- `skillsDir()` returns `.agent/skills/`, `instructionsFile()` returns `GEMINI.md`.
- Registration is complete: `types.ts` union, `config.ts` schema, `registry.ts` factory.

## Notes

- Model defaults stay out of this task (handled by default-model tasks).
- Preserve project isolation semantics (`cwd`) exactly as with other engines.
- The JSONL event schema for Gemini CLI may differ from Claude in field names — the adapter must map Gemini's event structure to HAL's `EngineResult` / `ParsedResponse` types. Exact field mapping should be confirmed during implementation by inspecting actual `stream-json` output.
- Gemini CLI also supports `--include-directories` for multi-root workspaces — out of scope for this task but worth noting for future enhancement.
