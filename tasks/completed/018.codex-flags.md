# 018 — Codex Engine Permission Flags

Status: completed

Subsumes task 012 (skip-git-repo-check).

## Summary

Extend the engine configuration with Codex-specific options to control sandbox permissions, network access, and approval policy per-project. Currently the Codex adapter hardcodes `--full-auto --skip-git-repo-check`, which maps to `--sandbox workspace-write --ask-for-approval on-request --skip-git-repo-check` — blocking network access and writes to protected paths (`.git`, `.codex`, `.agents`).

## Motivation

- Codex cannot fetch URLs or perform web requests (e.g., "fetch this repo's README") because the `workspace-write` sandbox blocks outbound network by default.
- Codex cannot manage files under `.agents/skills/` or `.hal/commands/` because those are hardcoded read-only paths in `workspace-write` mode.
- The `--skip-git-repo-check` flag is hardcoded but should be an explicit opt-in.
- Operators need a way to grant elevated permissions per-project without editing adapter code.

## Configuration Schema

Add a `codex` object to the engine config in `hal.config.json`:

```json
{
  "engine": {
    "name": "codex",
    "codex": {
      "skipGitRepoCheck": true,
      "networkAccess": false,
      "fullDiskAccess": false,
      "dangerouslyEnableYolo": false
    }
  }
}
```

All flags default to `false`.

## Flag Definitions

### `skipGitRepoCheck` (boolean, default: `false`)

Bypasses Codex's trusted-directory check. Without this flag, Codex refuses to run in directories that haven't been explicitly trusted via onboarding or the `/approvals` menu.

**Codex flag mapping:** passes `--skip-git-repo-check`.

**Note:** HAL currently hardcodes this flag. This task makes it an explicit config option. Most HAL deployments will need this set to `true` since there's no way to trust a directory through the Telegram bot.

### `networkAccess` (boolean, default: `false`)

Unlocks outbound network for Codex shell commands (HTTP requests, curl, fetch, etc.).

**Codex flag mapping:** adds `-c sandbox_workspace_write.network_access=true` while keeping the `workspace-write` sandbox intact.

**What changes:** shell commands spawned by Codex can make outbound connections. Filesystem restrictions remain the same as default (workspace-writable, protected paths read-only).

### `fullDiskAccess` (boolean, default: `false`)

Grants unrestricted filesystem read/write access, including to protected paths (`.git`, `.codex`, `.agents`).

**Codex flag mapping:** replaces `--full-auto` with `--sandbox danger-full-access --ask-for-approval never`.

- `danger-full-access` is the only sandbox mode that unlocks writes to protected directories like `.agents/skills/`.
- `--ask-for-approval never` is required because HAL spawns Codex with stdin disabled (`stdio: ["ignore", "pipe", "pipe"]`) — there is no input channel for approval prompts. The official Codex docs recommend `never` for non-interactive / `codex exec` usage.
- Network is also unlocked as a side effect of `danger-full-access`, so `networkAccess` becomes redundant when this flag is set.

### `dangerouslyEnableYolo` (boolean, default: `false`)

Maximum permissive mode. Disables all sandboxing and all approval prompts entirely.

**Codex flag mapping:** uses `--dangerously-bypass-approvals-and-sandbox` (alias: `--yolo`).

**Difference from `fullDiskAccess`:** `fullDiskAccess` still runs commands through the sandbox infrastructure (Landlock/Seatbelt initialized in permissive mode). `dangerouslyEnableYolo` bypasses the sandbox infrastructure entirely — no process wrapping, no syscall filtering. It also sets `web_search = "live"` by default. **Only use in externally hardened environments (Docker, VMs).**

Supersedes both `fullDiskAccess` and `networkAccess` when enabled.

## Flag Precedence (Escalating Tiers)

These flags form escalating permission tiers. A higher tier supersedes lower ones:

| Tier | Config | Codex CLI flags | `--skip-git-repo-check` |
|------|--------|-----------------|------------------------|
| 0 (default) | all `false` | `--full-auto` | only if `skipGitRepoCheck: true` |
| 1 | `networkAccess: true` | `--full-auto -c sandbox_workspace_write.network_access=true` | only if `skipGitRepoCheck: true` |
| 2 | `fullDiskAccess: true` | `--sandbox danger-full-access --ask-for-approval never` | **implied** (always passed) |
| 3 | `dangerouslyEnableYolo: true` | `--dangerously-bypass-approvals-and-sandbox` | **implied** (always passed) |

`skipGitRepoCheck` is standalone at tiers 0–1 (must be explicitly set), but **implied by tiers 2–3** — granting `fullDiskAccess` or `dangerouslyEnableYolo` automatically passes `--skip-git-repo-check` since elevated access implies directory trust.

The adapter resolves from most permissive down. Conflicting combinations (e.g., `fullDiskAccess: true` + `networkAccess: false`) are resolved in favor of the higher tier.

## Implementation

### Config schema (`src/config.ts`)

Add a `CodexEngineConfigSchema` inside `EngineConfigSchema`:

```typescript
const CodexEngineConfigSchema = z.object({
  skipGitRepoCheck: z.boolean().optional(),
  networkAccess: z.boolean().optional(),
  fullDiskAccess: z.boolean().optional(),
  dangerouslyEnableYolo: z.boolean().optional(),
}).optional();
```

Add `codex: CodexEngineConfigSchema` to the engine config object. Resolve the values in `resolveProjectConfig()` and expose them on `ResolvedProjectConfig`.

### Codex adapter (`src/engine/adapters/codex.ts`)

Pass the resolved codex config to `createCodexAdapter()`. In the `execute()` method, compute CLI args based on the highest active tier:

```
if dangerouslyEnableYolo:
  use --dangerously-bypass-approvals-and-sandbox --skip-git-repo-check
elif fullDiskAccess:
  use --sandbox danger-full-access --ask-for-approval never --skip-git-repo-check
elif networkAccess:
  use --full-auto -c sandbox_workspace_write.network_access=true
  if skipGitRepoCheck: append --skip-git-repo-check
else:
  use --full-auto (current default)
  if skipGitRepoCheck: append --skip-git-repo-check
```

Remove the current hardcoded `--skip-git-repo-check` from the adapter.

### Logging

Log the resolved permission tier at engine startup (info level) so operators can verify what's active. Log a warning when `dangerouslyEnableYolo` is set.

## Reference: Codex CLI Permission Model

### Sandbox modes (`--sandbox`)

| Mode | Filesystem | Network | Protected paths |
|------|-----------|---------|----------------|
| `read-only` | Read anywhere, write nowhere | Blocked | N/A |
| `workspace-write` | Read anywhere, write in workspace + `/tmp` | Blocked (opt-in via config) | `.git`, `.codex`, `.agents` are read-only |
| `danger-full-access` | Unrestricted read/write | Allowed | None — all paths writable |

### Approval policies (`--ask-for-approval`)

| Policy | Behavior |
|--------|----------|
| `untrusted` | Only known-safe read ops auto-execute; mutations need approval |
| `on-request` | Auto-execute within sandbox bounds; escalations need approval |
| `never` | Fully autonomous — no prompts (recommended for non-interactive / `codex exec`) |

### Convenience flags

| Flag | Equivalent to |
|------|---------------|
| `--full-auto` | `--sandbox workspace-write --ask-for-approval on-request` |
| `--yolo` | No sandbox + no approvals + `web_search = "live"` |

### Non-interactive context (HAL)

HAL spawns Codex with `stdio: ["ignore", "pipe", "pipe"]` — stdin is disabled. Codex cannot display approval prompts or receive user input. The `on-request` policy effectively degrades to "auto-reject anything outside sandbox bounds" since there's no TTY. For elevated tiers, `--ask-for-approval never` is used explicitly.
