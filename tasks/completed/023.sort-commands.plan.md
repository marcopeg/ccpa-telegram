# 023 — Sort commands in /help and Telegram UI — Plan

## Phase 1: Define canonical source ordering (`src/bot/commands/loader.ts`) — DONE

### Step 1.1 — Add `SOURCE_ORDER` constant — DONE
Added `SOURCE_ORDER` record mapping each `CommandSource` to a numeric priority (project=0, skill=1, system=2, builtin=3, git=4).

### Step 1.2 — Add `sortBySource` utility — DONE
Added comparator function that sorts `CommandEntry[]` by `SOURCE_ORDER`.

### Step 1.3 — Sort `loadCommands()` output — DONE
Changed return to `Array.from(map.values()).sort(sortBySource)`. All consumers now receive commands in the correct group order.

---

## Phase 2: Rename git section header (`src/bot/commands/message.ts`) — DONE

### Step 2.1 — Rename `*Git Commands:*` to `*Versioning:*` — DONE
Changed the section header in `buildHalCommands()`.

### Step 2.2 — Update JSDoc comment — DONE
Updated the function's doc comment to reflect the new section name.

---

## Phase 3: Fix hot-reload watcher (`src/bot/commands/watcher.ts`) — DONE

### Step 3.1 — Ensure watched directories exist before starting chokidar — DONE
Added `mkdirSync(dir, { recursive: true })` for each watch path before calling `chokidar.watch()`. This ensures chokidar establishes real fs watches from the start, even when directories don't exist yet.

### Step 3.2 — Verify add/change/unlink handling
Manual verification needed:
- **add**: drop a new `.mjs` file into `.hal/commands/` → appears in Telegram menu.
- **change**: edit an existing `.mjs` description → updated in Telegram menu.
- **unlink**: remove a `.mjs` file → disappears from Telegram menu.
- Same for `SKILL.md` files in the skills directory.

---

## Phase 4: Verify end-to-end — DONE

### Step 4.1 — Build and lint — DONE
`pnpm run build` and `pnpm run lint` both pass cleanly with no errors.

### Step 4.2 — Manual verification checklist
- [ ] Start the bot with no project commands/skills dirs existing → dirs are created, watcher starts cleanly.
- [ ] `/help` shows sections in order: Project Commands, Project Skills, System Commands, Hal Commands, Versioning.
- [ ] Git section header reads "Versioning", not "Git Commands".
- [ ] Telegram command menu shows commands in the correct group order.
- [ ] Add a `.mjs` command file while the bot runs → appears in Telegram menu without restart.
- [ ] Remove it → disappears from Telegram menu without restart.

---

## Files changed

| File | Change |
|------|--------|
| `src/bot/commands/loader.ts` | Add `SOURCE_ORDER`, `sortBySource`, sort in `loadCommands()` |
| `src/bot/commands/message.ts` | Rename git section header to "Versioning", update JSDoc |
| `src/bot/commands/watcher.ts` | `mkdirSync` for watched dirs before starting chokidar |
