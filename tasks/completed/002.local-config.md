# Task 002 — Local config + env-var substitution

## Goal

Extend `src/config.ts` so that:

1. A `ccpa.config.local.json` file (gitignored) is optionally loaded alongside `ccpa.config.json` and deep-merged into it.
2. Environment variables are substituted into any string value of the final merged config.
3. A boot-time `info`-level log explains exactly which files were sourced and in what order.

---

## 1. Local config file (`ccpa.config.local.json`)

### Schema

The local file is **fully partial** — every field is optional. It does not need to satisfy the full `MultiConfigFileSchema`. Its only structure constraint is:

```ts
{
  globals?: DeepPartial<GlobalsFile>,
  projects?: Array<DeepPartial<ProjectFileEntry> & { name?: string; cwd?: string }>
}
```

### Merge strategy — deep merge

`ccpa.config.local.json` is deep-merged **on top of** `ccpa.config.json`. Scalars and arrays from the local file override their counterparts; objects are merged recursively.

### Project matching

When the local file contains a `projects` array, each local project entry is matched to a base project using:

1. **`name`** field (preferred) — matched when both entries have the same `name`.
2. **`cwd`** field (fallback) — used when no `name` is present.
3. If a local project entry cannot be matched by either key → **error at boot** with a clear message:
   ```
   Configuration error: local project "<name|cwd>" not found in ccpa.config.json
   ```

**No additive projects from the local file.** Every local project entry must map to an existing base project.

---

## 2. Variable substitution

After merging the two config files (pre-Zod validation), traverse **all string values** in the resulting object and replace any `${VAR_NAME}` occurrences with the resolved value from the environment.

### .env file resolution order (per substitution pass)

For each variable, the value is looked up in this priority order (first match wins):

1. `<config-dir>/.env.local`
2. `<config-dir>/.env`
3. Per-project `<project.cwd>/.env.local`
4. Per-project `<project.cwd>/.env`
5. `process.env` (bash/shell context)

> **Note:** `.env` files are loaded once at startup; they do not reload between projects.

### Missing variable → error at boot

If a `${VAR_NAME}` reference cannot be resolved from any source:

```
Configuration error: environment variable "VAR_NAME" is not defined
  (referenced in field: projects[0].telegram.botToken)
```

### Scope

Substitution applies to **every string field** in the merged config object (including `cwd`, `dataDir`, `command`, `botToken`, etc.).

---

## 3. Boot-time sourcing log

At `info` level, emit a structured log entry (or a human-readable line) immediately after config loading, listing:

- Which config files were found and loaded (base + optional local).
- Which `.env` files were found and loaded.
- The order in which they were applied.

Example log output:

```
[info] Configuration sourced:
  1. ccpa.config.json        (/path/to/ccpa.config.json)
  2. ccpa.config.local.json  (/path/to/ccpa.config.local.json)  [local override]
  3. .env.local              (/path/to/.env.local)
  4. .env                    (/path/to/.env)
  env: process.env           (bash context, last resort)
```

Files that were not found should be omitted (or logged as "not found" at `debug` level).

---

## 4. `.gitignore` requirement

Ensure `ccpa.config.local.json` and `.env.local` are listed in `.gitignore`.

---

## 5. Out of scope

- Per-project `.env` files loaded before config-dir `.env` files (see resolution order above — config-dir files take priority).
- Circular variable references (no need to detect).
- Watch/reload of config files at runtime.
