# Config hot-reload

## Goal

Add hot-reload when any file that contributes to the configuration changes: stop all running bots gracefully, reload configuration, and start bots again for the (possibly changed) set of projects. The process keeps running; reload is always enabled (not dev-only).

## Trigger files

Only the **hal config** (config directory) triggers this full stop-and-relaunch. A reload must be triggered when any of these files in the config directory change:

- `hal.config.json`
- `hal.config.local.json`
- `.env`
- `.env.local`

Do **not** watch per-project `cwd/.env` or `cwd/.env.local` for this reload. Project-level changes (hooks, commands, skills) are handled by other reload mechanisms and are a different level.

## Graceful stop

When a reload is triggered:

1. **Stop accepting new work** — stop all bots so they no longer accept new Telegram updates.
2. **Let in-flight requests finish** — if a bot is busy handling a request (e.g. an engine call), that request must complete successfully. Only after it completes may that bot be fully terminated.
3. **Then terminate** — once all in-flight work is done, shut down the bot immediately (no extra delay).

The existing `BotHandle.stop()` (stop watcher, rate-limit cleanup, `bot.stop()`, await run loop) should be used. If it does not already allow in-flight requests to complete before resolving, the implementation must ensure that behavior (e.g. Grammy's `bot.stop()` semantics or explicit tracking of in-flight work).

## Reload behavior (full reload)

1. **Debounce** — file watch events should be debounced (e.g. 300–500 ms) so that editing multiple files or save/backup tools don't trigger multiple reloads.
2. **Stop all current bots** — call `stop()` on every current `BotHandle` and await all of them (graceful as above).
3. **Reload configuration** — call `loadMultiConfig(configDir)` again. If loading or validation fails, log the error and keep the previous bots stopped (do not restart with old config; optional: exit process or retry on next file change).
4. **Resolve new project list** — resolve projects from the new config (same logic as startup: globals, inactive filter, `validateProjects`). Project set may have changed (add/remove/edit).
5. **Start bots for new set** — build new `ProjectContext[]`, call `startBot()` for each, store new handles.
6. **Keep config watcher** — the watcher is always the same set of files (config dir only), so keep it running or restart it on the same paths after each reload.


## Implementation notes

- Use **chokidar** (already a dependency) for watching. Watch the exact trigger files or their parent directories with appropriate filters; avoid watching entire trees.
- The **run loop** in the CLI currently runs once: `runStart(configDir)` then waits for signals. Hot-reload requires a loop: run start, set up config watcher (config dir only); on change → stop bots, reload config, start bots again; repeat. Consider extracting "run one cycle" (load config → resolve projects → start bots → return handles) and "run with config watcher" (loop: run cycle, watch config dir; on change: stop handles, run cycle again).
- **Signals (SIGINT/SIGTERM)** should still stop all current bots and exit. Ensure the config watcher is closed on process shutdown.
- **Logging:** log when config change is detected, when bots are being stopped, when reload fails, and when the new set of bots has started (with count/slugs).

## Out of scope

- Hot-reload of **code** (e.g. handler changes) — that remains the responsibility of the process manager (e.g. `tsx watch` in dev). Only hal config file changes are in scope.
- **Project-level** reloads (hooks, commands, skills) — already handled by other mechanisms; they do not trigger a full bot stop-and-relaunch.
