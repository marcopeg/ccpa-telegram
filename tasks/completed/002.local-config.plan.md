# Plan — Task 002: Local config + env-var substitution

Progress legend: `[ ]` pending · `[x]` done · `[-]` skipped

---

## Phase 1 — .env loading

**Goal:** Load `.env` and `.env.local` files from both the config dir and each project cwd, building a merged env map that variable substitution can query.

### Steps

- [x] **1.1** Add a `loadEnvFiles(configDir: string, projectCwds: string[]): EnvSources` function in `src/config.ts`.
  - Uses `dotenv`'s `parse()` (not `config()`) to read each file without polluting `process.env`.
  - Resolution order (first match wins during substitution): config-dir `.env.local` → config-dir `.env` → per-project `.env.local` → per-project `.env` → `process.env`.
  - Returns a `{ vars: Record<string, string>; loadedFiles: string[] }` object where `loadedFiles` lists every file that was actually found and read (for the boot log).

---

## Phase 2 — Variable substitution

**Goal:** Walk the raw merged JSON object and replace every `${VAR_NAME}` occurrence in string values before Zod validation.

### Steps

- [x] **2.1** Add a `substituteEnvVars(obj: unknown, env: Record<string, string>, path?: string): unknown` recursive function.
  - Traverses objects and arrays; replaces `${VAR}` in strings.
  - On an unresolved variable: prints a clear error message including the field path and variable name, then calls `process.exit(1)`.
  - Returns a new object (does not mutate in place).

---

## Phase 3 — Local config loading and deep merge

**Goal:** Optionally load `ccpa.config.local.json`, validate it against a partial schema, and deep-merge it on top of the base config.

### Steps

- [x] **3.1** Define `LocalConfigFileSchema` in `src/config.ts` — a fully partial variant of `MultiConfigFileSchema` where every field (including nested ones) is optional. The `projects` array items only require a `name` or `cwd` key for matching.

- [x] **3.2** Add a `loadLocalConfig(configDir: string): LocalConfigFile | null` function.
  - Returns `null` if `ccpa.config.local.json` does not exist.
  - On parse or schema error: exits with a clear message.

- [x] **3.3** Add a `deepMerge(base: object, override: object): object` utility (pure function, no external deps).
  - Plain objects → recurse.
  - Arrays → override replaces base (no concat).
  - Scalar / `undefined` → override wins if defined.

- [x] **3.4** Add a `mergeLocalIntoBase(base: MultiConfigFile, local: LocalConfigFile): MultiConfigFile` function.
  - Merges `globals` via `deepMerge`.
  - For each local project entry: match to a base project by `name` first, then `cwd`. If no match → `process.exit(1)` with a clear error.
  - Replaces the matched base project with `deepMerge(baseProject, localProject)`.

---

## Phase 4 — Wire everything into `loadMultiConfig`

**Goal:** Update the public `loadMultiConfig` function to orchestrate the new steps in the correct order and return sourcing metadata for the boot log.

### Steps

- [x] **4.1** Change `loadMultiConfig` signature to also return `{ loadedFiles: string[] }` alongside `MultiConfigFile` (or return a combined object).

- [x] **4.2** New execution order inside `loadMultiConfig`:
  1. Read and parse `ccpa.config.json` (existing).
  2. Read and parse `ccpa.config.local.json` if present; deep-merge.
  3. Run `substituteEnvVars` on the merged raw object using the env map.
     - Load `.env` files **before** substitution using a preliminary pass of project cwds from the merged raw object.
  4. Run `MultiConfigFileSchema.safeParse` on the substituted object (existing validation).
  5. Return data + list of loaded files.

- [x] **4.3** Update call sites in `src/cli.ts` to destructure the new return shape.

---

## Phase 5 — Boot-time sourcing log

**Goal:** Emit an `info`-level log immediately after config loading that lists all sourced files in resolution order.

### Steps

- [x] **5.1** In `src/cli.ts` → `runStart`, after calling `loadMultiConfig`, emit a structured log:

  ```
  [info] Configuration sourced:
    1. ccpa.config.json       (/abs/path/ccpa.config.json)
    2. ccpa.config.local.json (/abs/path/ccpa.config.local.json)  [local override]
    3. .env.local             (/abs/path/.env.local)
    4. .env                   (/abs/path/.env)
    env: process.env          (bash context, last resort)
  ```

  Files not found are omitted from the list. The `process.env` line is always included last.

---

## Phase 6 — .gitignore audit

**Goal:** Confirm the gitignore already covers the new files (it already does based on a read of `.gitignore`).

### Steps

- [x] **6.1** Verify `.gitignore` already has `**/ccpa.config.local.json` and `**/.env.local`. Add any missing entries.

---

## Phase 7 — Examples update

**Goal:** Ensure the `examples/` directory demonstrates the new feature end-to-end.

### Steps

- [x] **7.1** Update `examples/ccpa.config.json` so the `obsidian` project uses `${OBSIDIAN_TELEGRAM_TOKEN}` (already does) and the `timetracker` project uses `${TIMETRACKER_TELEGRAM_TOKEN}` instead of a hard-coded empty string.
- [x] **7.2** Update `examples/ccpa.config.local.json` to show a minimal local override (only secrets, no `cwd` duplication).
- [x] **7.3** Update `examples/.env` (or add `examples/.env.example`) to list both token variables.

---

## Phase 8 — Lint & typecheck

- [x] **8.1** Run `pnpm run lint:fix` — fix any Biome issues.
- [x] **8.2** Run `pnpm run typecheck` — fix any TypeScript errors.

---

## Notes

- No new npm dependencies needed; `dotenv` (`^17.2.3`) is already installed and exports `parse`.
- `deepMerge` is implemented inline (< 20 lines); no lodash or similar.
- Zod validation runs **after** substitution so that `${VAR}` placeholders never reach the schema.
- The `EnvSources` type and `loadedFiles` list flow from Phase 1 → Phase 2 → Phase 4 → Phase 5.
