# Development plan: Codex Engine Permission Flags (018)

Plan for implementing task [018.codex-flags.md](./018.codex-flags.md). Three phases: config schema, adapter logic, documentation.

**Execution notes:** Task and plan moved to `tasks/`; BACKLOG updated to In Progress. Phase 1: Added `CodexEngineConfigSchema` with `.partial().optional()`, added `codex` to `EngineConfigSchema`, extended `ResolvedProjectConfig` with resolved `codex` (project → globals → false). Phase 2: Adapter reads `config.codex`, computes CLI args by tier (yolo → full-disk-access → network-access → default), adds `tier` to the existing logger.info and logger.warn when yolo. Phase 3: README engine table note + codex table, Codex section permission paragraph, globals/project table rows for `engine.codex.*`, example config obsidian engine block updated. All flags default to `false`; existing configs without `codex` load unchanged.

---

## Phase 1: Config schema and resolution

**Goal:** Add the `codex` config block to the engine schema and expose resolved flags on `ResolvedProjectConfig`.

### Steps

- [x] 1. **Add `CodexEngineConfigSchema` (src/config.ts)**
   - Define the schema after `EngineConfigSchema`:
     ```typescript
     const CodexEngineConfigSchema = z
       .object({
         skipGitRepoCheck: z.boolean(),
         networkAccess: z.boolean(),
         fullDiskAccess: z.boolean(),
         dangerouslyEnableYolo: z.boolean(),
       })
       .partial()
       .optional();
     ```
   - Add `codex: CodexEngineConfigSchema` to the engine config object inside `EngineConfigSchema` (the `.object({...})` before `.partial().optional()`).

- [x] 2. **Extend `ResolvedProjectConfig` interface (src/config.ts)**
   - Add a `codex` property to the interface:
     ```typescript
     codex: {
       skipGitRepoCheck: boolean;
       networkAccess: boolean;
       fullDiskAccess: boolean;
       dangerouslyEnableYolo: boolean;
     };
     ```

- [x] 3. **Resolve codex flags in `resolveProjectConfig()` (src/config.ts)**
   - After the existing engine field resolution (around line 340–347), resolve each codex flag using the same project → globals → default pattern:
     ```
     codex: {
       skipGitRepoCheck: project.engine?.codex?.skipGitRepoCheck ?? globals.engine?.codex?.skipGitRepoCheck ?? false,
       networkAccess: project.engine?.codex?.networkAccess ?? globals.engine?.codex?.networkAccess ?? false,
       fullDiskAccess: project.engine?.codex?.fullDiskAccess ?? globals.engine?.codex?.fullDiskAccess ?? false,
       dangerouslyEnableYolo: project.engine?.codex?.dangerouslyEnableYolo ?? globals.engine?.codex?.dangerouslyEnableYolo ?? false,
     }
     ```

- [x] 4. **Verify**
   - Ensure existing configs without `codex` still load (all fields optional, defaults to `false`).
   - Run `pnpm run lint` to confirm no type errors.

---

## Phase 2: Codex adapter — tier-based CLI flag computation

**Goal:** Replace hardcoded `--full-auto --skip-git-repo-check` with dynamic flag computation based on resolved codex config.

### Steps

- [x] 1. **Read codex config from `ctx.config` in `execute()` (src/engine/adapters/codex.ts)**
   - The adapter's `execute()` method already receives `ctx: ProjectContext` which contains `ctx.config: ResolvedProjectConfig`. Read `ctx.config.codex` at the start of execute.

- [x] 2. **Implement tier-based flag computation (src/engine/adapters/codex.ts)**
   - Replace line 63 (`args.push("--full-auto", "--skip-git-repo-check")`) with the tiered logic:
     ```
     if (codex.dangerouslyEnableYolo) {
       args.push("--dangerously-bypass-approvals-and-sandbox", "--skip-git-repo-check");
     } else if (codex.fullDiskAccess) {
       args.push("--sandbox", "danger-full-access", "--ask-for-approval", "never", "--skip-git-repo-check");
     } else if (codex.networkAccess) {
       args.push("--full-auto", "-c", "sandbox_workspace_write.network_access=true");
       if (codex.skipGitRepoCheck) args.push("--skip-git-repo-check");
     } else {
       args.push("--full-auto");
       if (codex.skipGitRepoCheck) args.push("--skip-git-repo-check");
     }
     ```

- [x] 3. **Add startup logging (src/engine/adapters/codex.ts)**
   - In the existing `logger.info(...)` call (line 66–74), add a `tier` field that indicates the resolved permission level. Compute a label string:
     - `dangerouslyEnableYolo` → `"yolo"`
     - `fullDiskAccess` → `"full-disk-access"`
     - `networkAccess` → `"network-access"`
     - default → `"default"`
   - When `dangerouslyEnableYolo` is true, add a `logger.warn(...)` call: `"Codex running with --yolo: all sandboxing and approvals disabled"`.

- [x] 4. **Verify**
   - Run `pnpm run build` to confirm TypeScript compiles.
   - Run `pnpm run lint` to confirm no linting issues.

---

## Phase 3: Documentation

**Goal:** Document the new codex config options in README and update the example config.

### Steps

- [x] 1. **Update engine config table in README**
   - In the "Engine Configuration" section, after the existing 5-field engine table (around line 456–462), add a note that the engine object also accepts engine-specific sub-objects, then document the `codex` fields:

     | Field | Description | Default |
     |-------|-------------|---------|
     | `codex.skipGitRepoCheck` | Bypass Codex trusted-directory check | `false` |
     | `codex.networkAccess` | Allow outbound network in shell commands | `false` |
     | `codex.fullDiskAccess` | Unrestricted filesystem access (implies network + skipGitRepoCheck) | `false` |
     | `codex.dangerouslyEnableYolo` | Disable all sandboxing and approvals | `false` |

- [x] 2. **Update the Codex engine section in README (around line 478–483)**
   - Add a paragraph explaining the permission flags and their escalating tiers.
   - Note that `fullDiskAccess` and `dangerouslyEnableYolo` imply `skipGitRepoCheck`.
   - Warn that `dangerouslyEnableYolo` should only be used in hardened environments.

- [x] 3. **Update globals config table in README (around line 270–276)**
   - Add `globals.engine.codex.*` entries referencing the codex flags.

- [x] 4. **Update per-project config table in README (around line 297–303)**
   - Add `engine.codex.*` entries.

- [x] 5. **Update example config (examples/hal.config.json)**
   - Add a `codex` block to the obsidian project (which uses engine `codex`):
     ```json
     "engine": {
       "name": "codex",
       "codex": {
         "skipGitRepoCheck": true,
         "networkAccess": true
       }
     }
     ```

- [x] 6. **Verify**
   - Review README renders correctly (no broken tables or links).

---

## Summary and order

| Phase | Description | Files |
|-------|-------------|-------|
| 1 | Config schema: `CodexEngineConfigSchema`, resolve to `ResolvedProjectConfig.codex` | `src/config.ts` |
| 2 | Adapter: tier-based CLI flag computation, logging | `src/engine/adapters/codex.ts` |
| 3 | Docs: README tables, Codex section, example config | `README.md`, `examples/hal.config.json` |

Dependencies: Phase 2 depends on Phase 1 (needs the resolved config type). Phase 3 is independent and can be done in parallel with Phase 2.

No changes needed to `src/engine/registry.ts`, `src/engine/types.ts`, or `src/cli.ts` — the adapter already receives the full `ResolvedProjectConfig` via `ctx.config` in its `execute()` method.
