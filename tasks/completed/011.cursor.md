# 011 — Add Cursor Engine

Status: completed

Add support for the Cursor agent CLI as an engine adapter. Scope: **cursor adapter only** — no docs changes, no other engine modifications.

## Config shape

Same as existing engines:

```json
"engine": {
    "name": "cursor",
    "model": "claude-4-sonnet-thinking",
    "session": true,
    "sessionMsg": "hi!"
}
```

- **name**: `"cursor"`
- **model**: Any model available via `agent models` (e.g. `claude-4-sonnet-thinking`, `gpt-5`). No default — omit `--model` flag when not set (lets Cursor use its own default).
- **session** / **sessionMsg**: Same semantics as Copilot/Codex. `--continue` resumes last session; session renewal sends `sessionMsg` without `--continue`.

## Cursor CLI reference (confirmed from [docs](https://cursor.com/docs/cli/reference/parameters))

The CLI binary is `agent` (the standalone Cursor Agent). No subcommand needed — it starts in agent mode by default. For scripted non-interactive use:

```
agent --print --workspace <dir> [--model <model>] [--continue] [--trust] [--force] [--output-format text] "<prompt>"
```

Key flags:
| Flag | Purpose |
|---|---|
| `--print` / `-p` | Non-interactive mode — print response and exit. **Required.** |
| `--workspace <dir>` | Set project working directory |
| `--model <model>` | Override model |
| `--continue` | Resume last session (alias for `--resume=-1`) |
| `--trust` | Trust workspace without prompting (headless) |
| `--force` / `--yolo` | Auto-approve tool use without prompting |
| `--output-format <fmt>` | `text` (default), `json`, or `stream-json` |
| `-v, --version` | Print version |

The prompt is a **positional argument** (not a flag value).

## Implementation plan

### 1. Create `src/engine/adapters/cursor.ts`

New file. Follow the Copilot adapter pattern (buffered stdout, plain text output). Factory signature: `createCursorAdapter(command?: string, model?: string): EngineAdapter`.

Default command: `"agent"`.

**`check()`**: Run `<cmd> --version` via `execSync` (the `-v`/`--version` flag is a global option). Throw descriptive error if not found.

**`execute()`**:
- Build args array (no subcommand needed — `agent` binary defaults to agent mode):
  - `--print` — always (non-interactive mode)
  - `--workspace`, `config.cwd` — always
  - `--model`, `model` — only when `model` is set
  - `--trust` — always (headless operation)
  - `--force` — always (auto-approve tool calls)
  - `--continue` — only when `config.engineSession && continueSession !== false`
  - Append `fullPrompt` as the final positional argument
- Spawn the process with `cwd` set to `config.cwd`, `stdio: ["ignore", "pipe", "pipe"]`
- Collect stdout/stderr buffers
- On close: resolve `EngineResult` with `success: code === 0`
- Send progress via `onProgress("Cursor is responding...")` when stdout chunks arrive (same as Copilot)

**`parse()`**: Simple — return `result.output` on success, `result.error` on failure (same as Copilot/Codex).

**`skillsDir()`**: Return `join(projectCwd, ".cursor", "rules")` — Cursor uses `.cursor/rules/` for project rules.

**`instructionsFile()`**: Return `".cursorrules"`.

### 2. Modify `src/engine/types.ts`

Add `"cursor"` to the `EngineName` union type and `ENGINE_NAMES` array:

```typescript
export type EngineName = "claude" | "copilot" | "codex" | "opencode" | "cursor";

export const ENGINE_NAMES: readonly EngineName[] = [
  "claude",
  "copilot",
  "codex",
  "opencode",
  "cursor",
] as const;
```

### 3. Modify `src/engine/registry.ts`

Import and register the factory:

```typescript
import { createCursorAdapter } from "./adapters/cursor.js";

const factories: Record<EngineName, AdapterFactory> = {
  claude: createClaudeAdapter,
  copilot: createCopilotAdapter,
  codex: createCodexAdapter,
  opencode: createOpencodeAdapter,
  cursor: createCursorAdapter,
};
```

### 4. Modify `src/config.ts`

Add `"cursor"` to the `EngineNameSchema` Zod enum (line 27):

```typescript
const EngineNameSchema = z.enum(["claude", "copilot", "codex", "opencode", "cursor"]);
```

### 5. Modify `src/cli.ts`

Add `"cursor"` to `VALID_ENGINES` (line 108-113) and update the `--engine` help text (line 79):

```typescript
const VALID_ENGINES: readonly EngineName[] = [
  "claude",
  "copilot",
  "codex",
  "opencode",
  "cursor",
];
```

Help text update:
```
  --engine <name>   Engine to use: claude, copilot, codex, opencode, cursor (default: claude)
```

### 6. Modify `src/bot/commands/session.ts`

Add `"cursor"` to the active-reset engine check (line 40). Cursor uses `--continue` like Copilot/Codex, so session renewal must send `sessionMsg` without continue to force a new engine session:

```typescript
if (config.engine === "copilot" || config.engine === "codex" || config.engine === "cursor") {
```

## Verification

After implementation, confirm:
1. `pnpm run build` compiles without errors
2. `pnpm run lint` passes (run `pnpm run lint:fix` if needed)
3. Config with `"engine": { "name": "cursor" }` is accepted by Zod validation
4. `--engine cursor` is accepted by the CLI arg parser
