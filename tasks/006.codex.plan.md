# Task 006 — Multi-engine support: Implementation Plan

## Complexity assessment: **Medium**

The codebase is well-structured with clear separation of concerns. Claude-specific logic is concentrated in a small number of modules (~6 files). The main challenge is defining an engine adapter interface that normalises CLI differences while preserving HAL features (context injection, commands, skills, sessions, streaming progress).

---

## Phase 1 — Engine abstraction + Copilot

### Step 1.1 — Define engine registry and adapter interface

**New file: `src/engine/types.ts`**

Define the canonical adapter contract:

```ts
export type EngineName = "claude" | "copilot" | "codex" | "opencode";

export interface EngineAdapter {
  /** Human-readable name for logs/errors */
  readonly name: string;
  /** CLI command (e.g. "claude", "copilot") */
  readonly command: string;
  /** Verify the CLI is installed and authenticated; throw on failure */
  check(): void;
  /** Execute a prompt and return a normalised result */
  execute(options: EngineExecuteOptions, ctx: ProjectContext): Promise<EngineResult>;
  /** Parse raw result into user-facing text (some engines need extra post-processing) */
  parse(result: EngineResult): ParsedResponse;
  /** Return the engine-specific skills directory path */
  skillsDir(projectCwd: string): string;
  /** Return the engine-specific instructions filename for init scaffolding */
  instructionsFile(): string;
}
```

Shared types (`EngineExecuteOptions`, `EngineResult`, `ParsedResponse`) live here too and replace the current `ExecuteOptions` / `ExecuteResult` / `ParsedResponse`.

**New file: `src/engine/registry.ts`**

```ts
const engines: Record<EngineName, () => EngineAdapter> = { ... };
export function getEngine(name: EngineName, command?: string): EngineAdapter;
```

Factory map; each value lazily constructs an adapter. `command` override allows custom CLI paths.

### Step 1.2 — Migrate existing Claude code into a Claude adapter

**New file: `src/engine/adapters/claude.ts`**

Move logic from `src/claude/executor.ts` and `src/claude/parser.ts` into a class implementing `EngineAdapter`. Keep the existing stream-json parsing, CLI args, and progress extraction exactly as-is.

- `check()` ← current `checkClaudeCommand()` from `bot.ts`
- `execute()` ← current `executeClaudeQuery()`
- `parse()` ← current `parseClaudeOutput()`
- `skillsDir()` → `join(cwd, ".claude", "skills")`
- `instructionsFile()` → `"CLAUDE.md"`

After migration, the old `src/claude/` directory becomes a thin re-export or is removed entirely.

### Step 1.3 — Implement Copilot adapter

**New file: `src/engine/adapters/copilot.ts`**

Implement `EngineAdapter` for the `copilot` CLI:

- `check()` — run `copilot --version`
- `execute()` — build `copilot` CLI args with prompt injection, streaming output, session resume
- `parse()` — normalise copilot output into `ParsedResponse`
- `skillsDir()` → `join(cwd, ".claude", "skills")` (shared across all engines for now)
- `instructionsFile()` → `"AGENTS.md"`

> **Confirmed**: `copilot` CLI exists as a standalone command (verified on host). Research still needed for exact flags (prompt input, streaming JSON, cwd scoping). Session resume is out of scope for non-Claude engines in v1.

### Step 1.4 — Add stub adapters for Codex and OpenCode

**New files:**
- `src/engine/adapters/codex.ts`
- `src/engine/adapters/opencode.ts`

Minimal implementations that:
- `check()` — verify CLI exists
- `execute()` — basic prompt → response (no streaming initially)
- `parse()` — pass-through
- `skillsDir()` → `join(cwd, ".claude", "skills")` (shared across all engines for now)
- `instructionsFile()` → `"AGENTS.md"`

Mark non-streaming and missing features with `// TODO` and clear log warnings.

### Step 1.5 — Update config schema

**File: `src/config.ts`**

| Change | Detail |
|--------|--------|
| Add `EngineSchema` | `z.enum(["claude", "copilot", "codex", "opencode"])` |
| Add `globals.engine` | Optional, defaults to `"claude"` |
| Add `projects[].engine` | Optional, overrides global |
| Replace `claude.command` | Remove `claude` config key entirely; replace with `engine` (name) + `engine.command` (CLI path override) |
| Update `ResolvedProjectConfig` | Replace `claude: { command }` with `engine: EngineName` and `engineCommand: string` |
| Update `resolveProjectConfig()` | Resolve engine + command with cascade: `project.engine → globals.engine → "claude"` |

No backward compatibility needed — early development, no users. Old `claude.command` key is removed, not deprecated.

### Step 1.6 — Update bot startup

**File: `src/bot.ts`**

Replace:
```ts
checkClaudeCommand(config.claude.command);
```
With:
```ts
const engine = getEngine(config.engine, config.engineCommand);
engine.check();
```

Thread the resolved `EngineAdapter` through `ProjectContext` (add `engine: EngineAdapter` to `ProjectContext` in `src/types.ts`).

Update `getSkillsDir()` call to use `engine.skillsDir(config.cwd)`.

### Step 1.7 — Update agent factory

**File: `src/agent/index.ts`**

Replace direct `executeClaudeQuery` call with engine adapter:

```ts
export function createAgent(projectCtx: ProjectContext): Agent {
  const { engine } = projectCtx;
  return {
    async call(prompt, options) {
      const result = await engine.execute({ prompt, userDir: "", onProgress: options?.onProgress }, projectCtx);
      if (!result.success) throw new Error(result.error ?? "Agent call failed");
      return result.output;
    },
  };
}
```

Update `getSkillsDir()` to delegate to engine adapter.

### Step 1.8 — Update handlers

**Files:** `src/bot/handlers/text.ts`, `photo.ts`, `document.ts`, `voice.ts`

Replace all direct `import { executeClaudeQuery }` / `import { parseClaudeOutput }` with calls through `ctx.engine.execute()` and `ctx.engine.parse()`.

This is largely mechanical: each handler already receives `ProjectContext`, so the change is:
```ts
// Before
const result = await executeClaudeQuery({ ... }, ctx);
const parsed = parseClaudeOutput(result);

// After
const result = await ctx.engine.execute({ ... }, ctx);
const parsed = ctx.engine.parse(result);
```

### Step 1.9 — Update CLI init command

**File: `src/cli.ts`**

- Add `--engine <name>` flag to `parseArgs()` (default: `"claude"`)
- Update `CONFIG_TEMPLATE` generation to include `"engine": "<name>"` in globals
- After writing `hal.config.json`, scaffold the engine-specific instructions file:
  ```ts
  const engine = getEngine(engineName);
  const instrFile = engine.instructionsFile(); // e.g. "AGENTS.md"
  // Write a starter instructions file if it doesn't exist
  ```

### Step 1.10 — Update context resolver

**File: `src/context/resolver.ts`**

- Rename `claudeSlug()` → `projectSlug()` (engine-agnostic naming)
- No functional change needed — context injection is engine-independent by design
- The `project.slug` value stays the same format for all engines

---

## Phase 2 — Add remaining engines (Codex, OpenCode)

### Step 2.1 — Research CLI interfaces

For each of `codex` and `opencode`:
- Document CLI flags for: prompt input, streaming output, session management, working dir
- Identify feature gaps vs Claude (e.g. no streaming → poll-based fallback)
- Confirm skills/instructions directory conventions

### Step 2.2 — Complete adapter implementations

Upgrade the stub adapters from Phase 1 Step 1.4 to full implementations with streaming support where available.

### Step 2.3 — Test matrix

Create integration test scenarios for each engine covering:
- Basic prompt → response
- Streaming progress updates
- Session resume
- Context injection verification
- Command/skill dispatch
- Error handling (CLI missing, auth expired, rate limited)

---

## Phase 3 — Close parity gaps and document limitations

### Step 3.1 — Feature parity audit

For each engine, document:
- Which HAL features work natively
- Which require a HAL compatibility layer
- Which are unsupported (with clear error messages)

### Step 3.2 — Compatibility layers

Implement HAL-side shims for missing engine features, e.g.:
- Session management for engines without native session resume (post-v1)
- Streaming simulation for engines that only support synchronous output
- Progress extraction patterns per engine

### Step 3.3 — Documentation

- Update README.md with engine configuration section
- Document per-engine limitations
- Update examples/ with multi-engine config samples

---

## File change summary

| File | Change type | Phase |
|------|-------------|-------|
| `src/engine/types.ts` | **New** — adapter interface + shared types | 1.1 |
| `src/engine/registry.ts` | **New** — engine factory/registry | 1.1 |
| `src/engine/adapters/claude.ts` | **New** — migrate from `src/claude/` | 1.2 |
| `src/engine/adapters/copilot.ts` | **New** — copilot CLI adapter | 1.3 |
| `src/engine/adapters/codex.ts` | **New** — stub, completed in Phase 2 | 1.4 |
| `src/engine/adapters/opencode.ts` | **New** — stub, completed in Phase 2 | 1.4 |
| `src/config.ts` | **Edit** — add engine schema + resolve logic | 1.5 |
| `src/types.ts` | **Edit** — add `engine` to `ProjectContext` | 1.6 |
| `src/bot.ts` | **Edit** — use engine adapter for check + skills | 1.6 |
| `src/agent/index.ts` | **Edit** — delegate to engine adapter | 1.7 |
| `src/bot/handlers/text.ts` | **Edit** — use `ctx.engine` | 1.8 |
| `src/bot/handlers/photo.ts` | **Edit** — use `ctx.engine` | 1.8 |
| `src/bot/handlers/document.ts` | **Edit** — use `ctx.engine` | 1.8 |
| `src/bot/handlers/voice.ts` | **Edit** — use `ctx.engine` | 1.8 |
| `src/cli.ts` | **Edit** — `--engine` flag + scaffold | 1.9 |
| `src/context/resolver.ts` | **Edit** — rename slug helper | 1.10 |
| `src/claude/executor.ts` | **Delete or re-export** after migration | 1.2 |
| `src/claude/parser.ts` | **Delete or re-export** after migration | 1.2 |
| `README.md` | **Edit** — engine docs | 3.3 |

---

## Open research items

1. ~~**Copilot CLI existence**~~: ✅ Confirmed — `copilot` runs as standalone CLI.
2. **Copilot CLI flags**: exact flags for prompt input, streaming JSON output, and cwd scoping.
3. **Codex CLI interface**: confirm `codex` CLI flags and streaming capabilities.
4. **OpenCode CLI interface**: confirm `opencode` CLI existence and capabilities.
5. ~~**Skills directory convention**~~: ✅ Decided — all engines share `.claude/skills/` for now.
6. ~~**Session resume for non-Claude**~~: ✅ Decided — not implemented in v1; fresh conversation per message.
