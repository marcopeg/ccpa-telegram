# Task 009 — Add Codex Engine: Implementation Plan

## Scope

- Turn the existing Codex **stub** adapter into a real engine: correct CLI invocation, session continuity via Codex's `--last` (adapter encapsulates exact mechanism), and config-driven `session` / `sessionMsg`.
- **Session**: Continue most recent session using Codex's mechanism (`resume --last`); no `session.json` or session ID in our code.
- **Output**: Buffered stdout is acceptable; no streaming requirement.
- **Renewal**: Codex behaves like Copilot — active reset for `/new` and `/clean` (send `engine.sessionMsg` without the "continue" flag; reply with engine output).

## Complexity: **Medium**

---

## Phase 1 — Codex CLI invocation (prompt, cwd, model) ✅

### Step 1.1 — Use positional prompt and `-C` for cwd ✅

- Codex: `[PROMPT]` is positional; `-p` is `--profile`. Adapter passes prompt positionally and uses `-C` / `--cd` for `config.cwd`.

### Step 1.2 — Keep model override ✅

- `-m` / `--model` when model is set.

### Step 1.3 — Optional: non-interactive ✅

- Default `[PROMPT]` behavior used; no extra flag needed.

---

## Phase 2 — Session continuity (Codex `--last`) ✅

### Step 2.1 — Confirm exact "continue" invocation ✅

- `codex resume --last [OPTIONS] [PROMPT]` with `-C`, `-m` as needed.

### Step 2.2 — Thread session options in the Codex adapter ✅

- Use `config.engineSession` and `continueSession`; when both allow, use `resume --last` + prompt; else normal invocation.

### Step 2.3 — No session ID in app code ✅

- Adapter does not read/write `sessionId`; Codex manages session state.

---

## Phase 3 — Session renewal: Codex = Copilot (active reset) ✅

### Step 3.1 — Extend session handler for Codex ✅

- In `src/bot/commands/session.ts`, treat Codex like Copilot: `config.engine === "copilot" || config.engine === "codex"` for active reset.

---

## Phase 4 — Config and docs ✅

### Step 4.1 — Example config

- Optional: add Codex example in `examples/hal.config.json`.

### Step 4.2 — Task doc

- Refined task in `tasks/009.codex.md` can state: session via `resume --last`; buffered output; Codex renewal = Copilot (active reset).

---

## Phase 5 — Validation

### Step 5.1 — Build and lint

- `pnpm run build` and `pnpm run lint`.

### Step 5.2 — Manual checks

- Codex + `session: true`: consecutive messages use same session.
- Codex + `session: false`: each message new session.
- `/new` and `/clean` with Codex: active reset, reply = engine output.

---

## Files changed

| File | Change |
|------|--------|
| `src/engine/adapters/codex.ts` | Positional prompt, `-C` cwd, session via `resume --last` when continuing; remove stub. |
| `src/bot/commands/session.ts` | Include Codex in active-reset branch. |
| `examples/hal.config.json` | Optional Codex example. |
